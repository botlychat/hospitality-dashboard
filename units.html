<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <base href="/chaletdashboard/">
  <title>Units — Hospitality Booking Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root{--bg:#f5f7fa;--bg-gradient:linear-gradient(130deg,#f5f7fa 0%,#f0f4ff 32%,#fff8f2 100%);--sidebar:#0f1729;--accent:#f97316;--accent-soft:rgba(249,115,22,0.12);--muted:#64748b;--card:#fff;--stroke:#e5e7eb}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:Inter,Segoe UI,Arial;background:var(--bg-gradient);margin:0;color:#111;position:relative}
    body::before{content:"";position:fixed;inset:0;background:radial-gradient(circle at 15% 20%,rgba(249,115,22,0.18),transparent 46%),radial-gradient(circle at 85% -10%,rgba(99,102,241,0.18),transparent 45%);pointer-events:none;opacity:.7}
    .app{display:flex;min-height:100vh;position:relative;z-index:1}
    /* Sidebar */
    .sidebar{width:260px;background:var(--sidebar);color:#fff;display:flex;flex-direction:column;padding:22px 20px;gap:18px;box-shadow:6px 0 24px rgba(15,23,41,0.12)}
    .brand{display:flex;align-items:center;gap:14px}
    .brand .logo{width:46px;height:46px;border-radius:14px;background:linear-gradient(140deg,var(--accent),#fdba74);display:flex;align-items:center;justify-content:center;font-weight:700;letter-spacing:.3px}
    .brand h1{font-size:17px;margin:0}
    nav{display:flex;flex-direction:column;gap:6px}
    .nav-item{display:flex;align-items:center;gap:12px;padding:11px;border-radius:10px;color:#d6d9df;cursor:pointer;transition:background .2s ease,transform .2s ease}
    .nav-item:hover,.nav-item.active{background:rgba(255,255,255,0.1);color:#fff;transform:translateX(2px)}
    .nav-item i{width:20px;text-align:center}
    .sidebar-footer{margin-top:auto;font-size:13px;color:rgba(255,255,255,0.55)}

    /* Main area */
    .main{flex:1;display:flex;flex-direction:column}
    .header{height:70px;background:rgba(255,255,255,0.85);backdrop-filter:blur(14px);display:flex;align-items:center;justify-content:space-between;padding:0 26px;border-bottom:1px solid rgba(15,23,41,0.06);gap:12px;position:sticky;top:0;z-index:5}
    .header .left{display:flex;align-items:center;gap:16px}
    .search{background:#fff;padding:9px 14px;border-radius:12px;box-shadow:0 6px 20px rgba(15,23,41,0.06);min-width:320px;display:flex;align-items:center}
    .search input{border:none;outline:none;margin-left:8px;font-size:14px;width:100%;background:transparent}
    .profile{display:flex;align-items:center;gap:10px;cursor:pointer;position:relative}
    .avatar{width:36px;height:36px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .profile-menu{position:absolute;right:0;top:48px;background:#fff;border-radius:10px;box-shadow:0 14px 30px rgba(15,23,41,0.12);min-width:190px;overflow:hidden;display:none}
    .profile-menu.show{display:block}
    .profile-menu button{width:100%;padding:10px 12px;border:none;background:transparent;text-align:left;cursor:pointer;font-size:14px}

    .content{padding:26px;display:grid;grid-template-columns:1fr 320px;gap:22px}

    /* Stat cards */
    .stat-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px}
    .stat-card{background:var(--card);padding:18px;border-radius:18px;box-shadow:0 14px 30px rgba(15,23,41,0.08);position:relative;overflow:hidden}
    .stat-card::after{content:"";position:absolute;inset:auto -30% -50px 55%;height:140px;background:var(--accent-soft);transform:skew(-22deg)}
    .stat-title{font-size:13px;color:var(--muted);margin-bottom:6px}
    .stat-value{font-size:28px;font-weight:700}
    .stat-sub{font-size:12px;color:var(--muted)}

    /* Filters */
    .toolbar{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;align-items:center;margin-bottom:16px}
    .toolbar-left{display:flex;flex-wrap:wrap;gap:10px}
    .filter{background:#fff;border:1px solid rgba(15,23,41,0.08);border-radius:12px;padding:8px 12px;display:flex;align-items:center;gap:8px;box-shadow:0 6px 18px rgba(15,23,41,0.05)}
    .filter select{border:none;font-size:13px;color:#111;background:transparent;outline:none}

    .page-title{margin:0;font-size:22px}

    .btn{padding:10px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:600;font-size:14px;transition:all .2s ease}
    .btn.primary{background:var(--accent);color:#fff;box-shadow:0 10px 24px rgba(249,115,22,0.24)}
    .btn.primary:hover{filter:brightness(.93)}
    .btn.ghost{background:rgba(255,255,255,0.7);border:1px solid rgba(15,23,41,0.08)}

    /* Table */
    .panel{background:var(--card);padding:18px;border-radius:18px;box-shadow:0 14px 30px rgba(15,23,41,0.08)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 14px;text-align:left;border-bottom:1px solid var(--stroke);font-size:13px}
    th{font-weight:600;color:#475569;background:rgba(15,23,41,0.03)}
    tbody tr:hover{background:rgba(249,115,22,0.04)}
    .unit-cell{display:flex;flex-direction:column}
    .unit-name{font-weight:600}
    .unit-meta{font-size:12px;color:var(--muted)}
    .status-pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:600}
    .status-pill.active{background:rgba(22,163,74,0.14);color:#15803d}
    .status-pill.maintenance{background:rgba(59,130,246,0.15);color:#1d4ed8}
    .status-pill.disabled{background:rgba(148,163,184,0.2);color:#475569}
    .actions{display:flex;gap:8px}
    .icon-btn{width:34px;height:34px;border-radius:10px;border:1px solid rgba(15,23,41,0.08);background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px}
    .icon-btn.danger{border-color:rgba(239,68,68,0.4);color:#b91c1c}
    .empty-state{padding:28px;border-radius:16px;border:1px dashed rgba(148,163,184,0.5);text-align:center;color:#64748b}

    /* Side column */
    .side-panel{display:flex;flex-direction:column;gap:16px}
    .tag-list{display:flex;flex-wrap:wrap;gap:8px}
    .tag{padding:6px 10px;border-radius:999px;background:rgba(148,163,184,0.18);font-size:12px;color:#475569}

    /* Sheet (off-canvas form) */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(15,23,42,0.36);display:none;align-items:stretch;justify-content:flex-end;z-index:20}
    .sheet-backdrop.show{display:flex}
    .sheet{width:520px;max-width:100%;background:#fff;height:100%;box-shadow:-24px 0 48px rgba(15,23,41,0.18);padding:26px 28px;display:flex;flex-direction:column;overflow-y:auto}
    .sheet-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .sheet-title{margin:0;font-size:20px}
    .close-btn{background:none;border:none;font-size:20px;cursor:pointer;color:#475569}
    .tabs{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
    .tab{padding:8px 14px;border-radius:10px;border:1px solid rgba(15,23,41,0.08);background:#f8fafc;cursor:pointer;font-size:13px;font-weight:600}
    .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .tab-panel{display:none;flex-direction:column;gap:14px}
    .tab-panel.active{display:flex}

    label{font-size:13px;color:#1f2937;font-weight:600}
    input[type="text"],input[type="number"],textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(148,163,184,0.4);font-size:13px;font-family:inherit}
    textarea{min-height:80px;resize:vertical}
    .field{display:flex;flex-direction:column;gap:6px}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .toggle-row{display:flex;align-items:center;gap:12px}
    .toggle-row input[type="checkbox"]{width:18px;height:18px}

    .dynamic-card{border:1px solid rgba(148,163,184,0.4);border-radius:12px;padding:12px;display:grid;gap:10px;background:#f8fafc}
    .dynamic-card .card-actions{display:flex;justify-content:flex-end}
    .weekday-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .weekday-card{background:#f8fafc;border:1px solid rgba(148,163,184,0.4);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:6px;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.6)}
    .weekday-card .weekday-label{font-size:12px;text-transform:uppercase;letter-spacing:.4px;color:#475569;font-weight:600}
    .weekday-card input{border-radius:10px;border:1px solid rgba(148,163,184,0.4);padding:8px 10px;font-size:13px}
    .rate-sub{font-size:11px;color:var(--muted)}
    .override-list{display:grid;gap:12px}
    .override-card{border:1px solid rgba(148,163,184,0.35);border-radius:12px;padding:12px;background:#fff;box-shadow:0 4px 14px rgba(15,23,41,0.06);display:grid;gap:10px}
    .override-meta{display:flex;gap:12px;flex-wrap:wrap}
    .override-meta .field{flex:1 1 160px}
    .override-card .card-actions{display:flex;justify-content:flex-end}

    .sheet-actions{display:flex;justify-content:space-between;align-items:center;margin-top:20px;gap:12px}

    .media-card{border:1px solid rgba(148,163,184,0.3);border-radius:12px;overflow:hidden;background:#f8fafc;display:flex;gap:12px;padding:12px}
    .media-card .preview{width:80px;height:80px;border-radius:8px;background:#e2e8f0;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0}
    .media-card .preview img,.media-card .preview video{width:100%;height:100%;object-fit:cover}
    .media-card .preview i{font-size:32px;color:#94a3b8}
    .media-card .info{flex:1;display:flex;flex-direction:column;justify-content:space-between}
    .media-card .info-name{font-size:12px;color:#64748b;word-break:break-all}
    .media-card .actions{display:flex;gap:6px;align-self:flex-start}
    .media-card .actions button{padding:4px 8px;font-size:11px}

    /* RTL Support */
    html[dir="rtl"] .sidebar{box-shadow:-6px 0 24px rgba(15,23,41,0.12)}
    html[dir="rtl"] .sheet{box-shadow:24px 0 48px rgba(15,23,41,0.18)}
    html[dir="rtl"] .profile{flex-direction:row-reverse}
    html[dir="rtl"] .search{margin-right:auto}
    html[dir="rtl"] .profile-menu{right:auto;left:0}
    html[dir="rtl"] .profile-menu button{text-align:right}
    html[dir="rtl"] .modal-actions{flex-direction:row-reverse}

    @media(max-width:1200px){.stat-cards{grid-template-columns:repeat(2,1fr)}.content{grid-template-columns:1fr}.weekday-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:980px){.sidebar{display:none}.search{display:none}.content{padding:18px}.sheet{width:100%}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand"><div class="logo">RG</div><h1>Riyadh Getaways</h1></div>
      <nav>
        <div class="nav-item" data-link="dashboard.html"><i class="fa-solid fa-gauge"></i> <span data-i18n="dashboard">Dashboard</span></div>
        <div class="nav-item" data-link="calendar.html"><i class="fa-regular fa-calendar"></i> <span data-i18n="calendar">Calendar</span></div>
        <div class="nav-item active" data-link="units.html"><i class="fa-solid fa-building"></i> <span data-i18n="units">Units</span></div>
        <div class="nav-item" data-link="website.html"><i class="fa-solid fa-globe"></i> <span data-i18n="website">Website Settings</span></div>
        <div class="nav-item" data-link="aiagent.html"><i class="fa-solid fa-robot"></i> <span data-i18n="aiagent">AI Agent</span></div>
        <div class="nav-item" data-link="contacts.html"><i class="fa-solid fa-address-book"></i> <span data-i18n="contacts">Contacts</span></div>
      </nav>
      <div class="sidebar-footer">© <strong>Riyadh Getaways</strong><br>Admin Dashboard</div>
    </aside>

    <main class="main">
      <header class="header">
        <div class="left">
          <h2 style="margin:0">Units</h2>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="search"><i class="fa-solid fa-magnifying-glass" style="color:var(--muted)"></i><input id="searchInput" data-i18n-placeholder="search" placeholder="Search units or IDs"></div>
          <div class="profile" id="profileBtn" tabindex="0">
            <div style="text-align:right;margin-right:8px;font-size:13px"><div style="font-weight:700" data-i18n="admin">Admin</div><div style="font-size:12px;color:var(--muted)">riyadh@getaways</div></div>
            <div class="avatar">A</div>
            <div class="profile-menu" id="profileMenu">
              <button id="profileSettings" data-i18n="completeProfile">Complete Profile</button>
              <button id="changePassword" data-i18n="changePassword">Change Password</button>
              <button id="changeEmail" data-i18n="changeEmail">Change Email</button>
              <div style="border-top:1px solid #e5e7eb;padding:8px 0;margin:8px 0;display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap">
                <button id="currencyUSD" style="display:flex;align-items:center;gap:4px;padding:8px 10px;border:none;background:transparent;cursor:pointer;font-size:12px;font-weight:600;color:#f97316;border-radius:6px;transition:all 0.2s ease" title="US Dollar">
                  USD
                </button>
                <button id="currencySAR" style="display:flex;align-items:center;gap:4px;padding:8px 10px;border:none;background:transparent;cursor:pointer;font-size:12px;font-weight:600;color:#64748b;border-radius:6px;transition:all 0.2s ease" title="Saudi Riyal">
                  SAR
                </button>
                <button id="currencyEUR" style="display:flex;align-items:center;gap:4px;padding:8px 10px;border:none;background:transparent;cursor:pointer;font-size:12px;font-weight:600;color:#64748b;border-radius:6px;transition:all 0.2s ease" title="Euro">
                  EUR
                </button>
                <div style="width:1px;height:16px;background:#e5e7eb"></div>
                <button id="langEnglish" style="width:auto;padding:8px 10px;border:none;background:transparent;cursor:pointer;font-size:12px;border-radius:6px;font-weight:600;color:#f97316;transition:all 0.2s ease" title="English">EN</button>
                <button id="langArabic" style="width:auto;padding:8px 10px;border:none;background:transparent;cursor:pointer;font-size:12px;border-radius:6px;color:#64748b;transition:all 0.2s ease" title="العربية">AR</button>
              </div>
              <button id="logoutBtn" data-i18n="logout">Logout</button>
            </div>
          </div>
        </div>
      </header>

      <section class="content">
        <div>
          <!-- Units Groups Tabs Section -->
          <div style="display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;padding-bottom:8px;border-bottom:2px solid #e5e7eb;align-items:center">
            <div id="groupsTabs" style="display:flex;gap:8px;flex:1">
              <!-- Group tabs will be rendered here -->
            </div>
            <button class="btn primary" onclick="openAddGroupModal()" style="flex-shrink:0"><i class="fa-solid fa-plus"></i> Add Group</button>
          </div>

          <div class="stat-cards">
            <div class="stat-card">
              <div class="stat-title">Total Units</div>
              <div class="stat-value" id="statTotal">0</div>
              <div class="stat-sub">Across all property types</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Active Listings</div>
              <div class="stat-value" id="statActive">0</div>
              <div class="stat-sub">Currently bookable</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Maintenance</div>
              <div class="stat-value" id="statMaintenance">0</div>
              <div class="stat-sub">Temporarily unavailable</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Average ADR</div>
              <div class="stat-value" id="statADR">$0</div>
              <div class="stat-sub">Average nightly rate</div>
            </div>
          </div>

          <div class="toolbar">
            <div class="toolbar-left">
              <div class="filter"><i class="fa-solid fa-filter"></i><select id="statusFilter"><option value="all">All Statuses</option><option value="Active">Active</option><option value="Maintenance">Maintenance</option><option value="Disabled">Disabled</option></select></div>
            </div>
            <button class="btn primary" id="addUnitBtn"><i class="fa-solid fa-plus"></i> Add New Unit</button>
          </div>

          <div class="panel">
            <table aria-label="Units list">
              <thead>
                <tr><th>Unit</th><th>Type</th><th>Max Guests</th><th>Nightly Rate</th><th>Status</th><th style="width:120px">Actions</th></tr>
              </thead>
              <tbody id="unitsTableBody"></tbody>
            </table>
          </div>
        </div>

        <aside class="side-panel">
          <div class="panel">
            <h3 style="margin-top:0">Amenities Overview</h3>
            <div class="tag-list" id="amenityTagList"></div>
          </div>
          <div class="panel">
            <h3 style="margin-top:0">Pricing Overrides</h3>
            <ul style="padding-left:18px;color:var(--muted);margin:0;display:flex;flex-direction:column;gap:6px" id="pricingOverridesList"></ul>
          </div>
        </aside>
      </section>
    </main>
  </div>

  <!-- Sheet -->
  <div class="sheet-backdrop" id="sheetBackdrop">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheet-header">
        <div>
          <h3 class="sheet-title" id="sheetTitle">Add Unit</h3>
          <div style="font-size:12px;color:var(--muted)" id="sheetSubtitle">Complete the form to create a new unit.</div>
        </div>
        <button class="close-btn" id="closeSheet" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="basic">Basic Info</button>
        <button class="tab" data-tab="pricing">Pricing</button>
        <button class="tab" data-tab="amenities">Amenities & Features</button>
        <button class="tab" data-tab="media">Media</button>
        <button class="tab" data-tab="policy">Cancellation & Refund</button>
      </div>

      <div class="tab-panel active" id="tab-basic">
        <div class="field"><label for="unitName">Unit Name</label><input id="unitName" type="text" placeholder="e.g. Palm Oasis Chalet"></div>
        <div class="grid-2">
          <div class="field"><label for="unitType">Unit Type</label><select id="unitType" onchange="updatePropertyFields()"><option value="Chalet">Chalet</option><option value="Hotel Room">Hotel Room</option><option value="Hotel Apartment">Hotel Apartment</option></select></div>
          <div class="field"><label for="unitStatus">Status</label><select id="unitStatus"><option value="Active">Active</option><option value="Maintenance">Maintenance</option><option value="Disabled">Disabled</option></select></div>
        </div>

        <!-- Saudi Arabia Property-Specific Fields -->
        <!-- Chalet Fields -->
        <div id="chaletFields" style="display:none">
          <div class="grid-2">
            <div class="field">
              <div class="toggle-row"><input id="chaletPool" type="checkbox"><label for="chaletPool" style="margin:0">Has Pool</label></div>
              <input id="chaletPoolSpecs" type="text" placeholder="Pool specifications" disabled style="margin-top:6px">
            </div>
            <div class="field">
              <div class="toggle-row"><input id="chaletGarden" type="checkbox"><label for="chaletGarden" style="margin:0">Has Garden</label></div>
              <input id="chaletGardenSpecs" type="text" placeholder="Garden specifications" disabled style="margin-top:6px">
            </div>
          </div>
          <div class="field">
            <label for="chaletAreas">Entertainment Areas</label>
            <input id="chaletAreas" type="text" placeholder="e.g. BBQ area, lounge, game room">
          </div>
        </div>

        <!-- Hotel Fields -->
        <div id="hotelFields" style="display:none">
          <div class="grid-2">
            <div class="field"><label for="floorNumber">Floor Number</label><input id="floorNumber" type="number" min="1" placeholder="e.g. 5"></div>
            <div class="field"><label for="roomView">Room View</label><select id="roomView"><option value="">Select View Type</option><option value="City View">City View</option><option value="Garden View">Garden View</option><option value="Pool View">Pool View</option><option value="Partial View">Partial View</option></select></div>
          </div>
          <div class="grid-2">
            <div class="field"><label for="starRating">Star Rating</label><select id="starRating"><option value="">Select Rating</option><option value="3">3 Stars</option><option value="4">4 Stars</option><option value="5">5 Stars</option></select></div>
            <div class="field"><label for="amenitiesHotel">Key Amenities</label><input id="amenitiesHotel" type="text" placeholder="e.g. WiFi, AC, Mini Bar"></div>
          </div>
        </div>

        <!-- Apartment Fields -->
        <div id="apartmentFields" style="display:none">
          <div class="grid-2">
            <div class="field"><label for="apartmentFloor">Floor Number</label><input id="apartmentFloor" type="number" min="1" placeholder="e.g. 3"></div>
            <div class="field"><label for="apartmentView">View Type</label><select id="apartmentView"><option value="">Select View Type</option><option value="City View">City View</option><option value="Garden View">Garden View</option><option value="Courtyard View">Courtyard View</option></select></div>
          </div>
          <div class="field"><label for="roomSize">Room Size Category</label><select id="roomSize"><option value="">Select Size</option><option value="Studio">Studio</option><option value="1BR">1 Bedroom</option><option value="2BR">2 Bedrooms</option><option value="3BR">3 Bedrooms</option></select></div>
        </div>
        <div class="grid-2">
          <div class="field"><label for="unitArea">Unit Area (m²)</label><input id="unitArea" type="number" min="0" placeholder="e.g. 240"></div>
          <div class="field"><label for="maxGuests">Max Guests</label><input id="maxGuests" type="number" min="1" placeholder="e.g. 8"></div>
        </div>
        <div class="grid-2">
          <div class="field"><label for="nightlyRate">Nightly Rate (USD)</label><input id="nightlyRate" type="number" min="0" placeholder="e.g. 650"></div>
          <div class="field toggle-row" style="align-items:center"><input id="parkingToggle" type="checkbox"><label for="parkingToggle" style="margin:0">Parking available</label></div>
        </div>
        <div class="grid-2">
          <div class="field"><label for="checkInHour">Check-In Hour (24h)</label><input id="checkInHour" type="number" min="0" max="23" placeholder="e.g. 15"></div>
          <div class="field"><label for="checkOutHour">Check-Out Hour (24h)</label><input id="checkOutHour" type="number" min="0" max="23" placeholder="e.g. 11"></div>
        </div>
        <div class="field"><label for="shortDescription">Short Description</label><input id="shortDescription" type="text" placeholder="One-line summary"></div>
        <div class="field"><label for="longDescription">Long Description</label><textarea id="longDescription" placeholder="Describe the experience, layout, amenities..."></textarea></div>
      </div>

      <div class="tab-panel" id="tab-pricing">
        <div class="field">
          <label>Weekday Pricing (per night)</label>
          <div class="weekday-grid" id="weekdayPricingGrid"></div>
        </div>
        <div class="field">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <label>Special Date Overrides</label>
            <button class="btn ghost" type="button" id="addOverrideBtn"><i class="fa-solid fa-plus"></i> Add Override</button>
          </div>
          <div class="override-list" id="overrideContainer"></div>
        </div>
      </div>

      <div class="tab-panel" id="tab-amenities">
        <div class="field"><label>Amenities</label>
          <div style="display:flex;flex-wrap:wrap;gap:10px" id="featureCheckboxes"></div>
        </div>
        <div class="grid-2">
          <div class="field">
            <div class="toggle-row"><input id="poolToggle" type="checkbox"><label for="poolToggle" style="margin:0">Has Pool</label></div>
            <input id="poolSpecs" type="text" placeholder="Pool specifications" disabled>
          </div>
          <div class="field">
            <div class="toggle-row"><input id="gardenToggle" type="checkbox"><label for="gardenToggle" style="margin:0">Has Garden</label></div>
            <input id="gardenSpecs" type="text" placeholder="Garden specifications" disabled>
          </div>
        </div>
        <div class="field">
          <div class="toggle-row"><input id="kitchenToggle" type="checkbox"><label for="kitchenToggle" style="margin:0">Has Kitchen</label></div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px" id="kitchenOptions"></div>
        </div>
        <div class="field">
          <div style="display:flex;justify-content:space-between;align-items:center"><label>Bedrooms</label><button class="btn ghost" type="button" id="addBedroomBtn"><i class="fa-solid fa-plus"></i> Add Bedroom</button></div>
          <div style="display:grid;gap:12px" id="bedroomsContainer"></div>
        </div>
        <div class="field">
          <div style="display:flex;justify-content:space-between;align-items:center"><label>Bathrooms</label><button class="btn ghost" type="button" id="addToiletBtn"><i class="fa-solid fa-plus"></i> Add Bathroom</button></div>
          <div style="display:grid;gap:12px" id="toiletsContainer"></div>
        </div>
      </div>

      <div class="tab-panel" id="tab-media">
        <div class="field">
          <label>Featured Image</label>
          <input id="featuredImageUpload" type="file" accept="image/*" style="padding:8px;border:2px dashed var(--accent);border-radius:8px">
          <div id="featuredImagePreview" style="margin-top:12px"></div>
        </div>

        <div class="field">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <label>Gallery Images</label>
            <button class="btn ghost" type="button" id="addGalleryImageBtn" style="padding:6px 12px;font-size:12px"><i class="fa-solid fa-plus"></i> Add Image</button>
          </div>
          <div id="galleryImagesContainer" style="display:grid;gap:12px;margin-top:12px"></div>
        </div>

        <div class="field">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <label>Unit Videos</label>
            <button class="btn ghost" type="button" id="addVideoBtn" style="padding:6px 12px;font-size:12px"><i class="fa-solid fa-plus"></i> Add Video</button>
          </div>
          <div id="videosContainer" style="display:grid;gap:12px;margin-top:12px"></div>
        </div>
      </div>

      <div class="tab-panel" id="tab-policy">
        <div class="field">
          <label>Cancellation & Refund Policy</label>
          <textarea id="policyText" placeholder="Enter your cancellation and refund policy here. Example: Free cancellation up to 7 days before check-in. After 7 days, full charge applies." style="min-height:250px"></textarea>
          <small style="color:var(--muted);margin-top:8px">Provide clear details about your cancellation terms, refund conditions, and any special policies.</small>
        </div>
      </div>

      <div class="sheet-actions">
        <button class="btn ghost" id="cancelSheet">Cancel</button>
        <button class="btn primary" id="saveUnitBtn">Save Unit</button>
      </div>
    </div>
  </div>

  <script>
  // Helper function to get proper file path (works on GitHub Pages)
  function getPagePath(filename) {
    const currentPath = window.location.pathname;
    // Check if we're on GitHub Pages (path contains /chaletdashboard/)
    if(currentPath.includes('/chaletdashboard/')) {
      return '/chaletdashboard/' + filename;
    }
    // Otherwise use relative path (local development)
    return filename;
  }

  const weekdayKeys = ['mon','tue','wed','thu','fri','sat','sun'];
  const weekdayLabels = {mon:'Monday',tue:'Tuesday',wed:'Wednesday',thu:'Thursday',fri:'Friday',sat:'Saturday',sun:'Sunday'};

  // Units Groups Management
  let unitsGroups = JSON.parse(localStorage.getItem('unitsGroups')) || [
    { id: 'group_1', name: 'Main Hotel', type: 'Hotel Room', license: 'TRN-2024-001' },
    { id: 'group_2', name: 'Chalets Collection', type: 'Chalet', license: 'TRN-2024-002' }
  ];
  let currentGroupId = localStorage.getItem('currentGroupId') || 'group_1';

  function saveGroupsToLocalStorage(){
    localStorage.setItem('unitsGroups', JSON.stringify(unitsGroups));
  }

  function setCurrentGroup(groupId){
    currentGroupId = groupId;
    localStorage.setItem('currentGroupId', groupId);
    renderGroupsTabs();
    renderTable();
    updateSummaries();
  }

  function renderGroupsTabs(){
    const container = document.getElementById('groupsTabs');
    container.innerHTML = '';
    unitsGroups.forEach(group => {
      const tab = document.createElement('button');
      tab.style.cssText = `padding:8px 16px;border:2px solid ${group.id === currentGroupId ? '#f97316' : '#e5e7eb'};background:${group.id === currentGroupId ? '#f97316' : 'transparent'};color:${group.id === currentGroupId ? '#fff' : '#111'};border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all .2s;white-space:nowrap`;
      tab.innerHTML = `<i class="fa-solid fa-layer-group"></i> ${group.name}`;
      tab.onclick = () => setCurrentGroup(group.id);
      container.appendChild(tab);
    });
  }

  function openAddGroupModal(){
    const backdrop = document.createElement('div');
    backdrop.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;z-index:5000';
    
    const modal = document.createElement('div');
    modal.style.cssText = 'background:#fff;border-radius:12px;padding:24px;max-width:450px;box-shadow:0 20px 40px rgba(0,0,0,0.15)';
    modal.innerHTML = `
      <h3 style="margin:0 0 20px 0;font-size:18px;font-weight:600;color:#0f1729">Create New Property Group</h3>
      <div style="margin-bottom:16px">
        <label style="display:block;font-weight:600;font-size:13px;margin-bottom:8px;color:#111">Group Name (Hotel/Apartment/Chalet Name)</label>
        <input type="text" id="groupNameInput" placeholder="e.g., Downtown Luxury Hotel" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-family:inherit;font-size:14px">
      </div>
      <div style="margin-bottom:16px">
        <label style="display:block;font-weight:600;font-size:13px;margin-bottom:8px;color:#111">Property Type</label>
        <select id="groupTypeInput" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-family:inherit;font-size:14px">
          <option value="Hotel Room">Hotel Room</option>
          <option value="Hotel Apartment">Hotel Apartment</option>
          <option value="Chalet">Chalet</option>
        </select>
      </div>
      <div style="margin-bottom:20px">
        <label style="display:block;font-weight:600;font-size:13px;margin-bottom:8px;color:#111">License Number (TRN)</label>
        <input type="text" id="groupLicenseInput" placeholder="e.g., TRN-2024-001" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-family:inherit;font-size:14px">
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button style="padding:10px 20px;border:none;background:#f0f0f0;color:#111;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
        <button style="padding:10px 20px;border:none;background:#f97316;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px" onclick="createNewGroup()">Create Group</button>
      </div>
    `;
    backdrop.appendChild(modal);
    document.body.appendChild(backdrop);
    document.getElementById('groupNameInput').focus();
  }

  function createNewGroup(){
    const name = document.getElementById('groupNameInput').value.trim();
    const type = document.getElementById('groupTypeInput').value;
    const license = document.getElementById('groupLicenseInput').value.trim();

    if(!name){
      alert('Please enter a group name');
      return;
    }
    if(!license){
      alert('Please enter a license number');
      return;
    }

    const newGroup = {
      id: 'group_' + Date.now(),
      name: name,
      type: type,
      license: license
    };

    unitsGroups.push(newGroup);
    saveGroupsToLocalStorage();
    setCurrentGroup(newGroup.id);
    document.querySelector('[style*="position:fixed"]').remove();
    alert(`✅ Property group "${name}" created successfully!`);
  }

  // Update visible property fields based on unit type
  function updatePropertyFields(){
    const unitType = document.getElementById('unitType').value;
    document.getElementById('chaletFields').style.display = unitType === 'Chalet' ? 'block' : 'none';
    document.getElementById('hotelFields').style.display = unitType === 'Hotel Room' ? 'block' : 'none';
    document.getElementById('apartmentFields').style.display = unitType === 'Hotel Apartment' ? 'block' : 'none';
  }

  // Toggle input field enabled state when checkbox changes
  function toggleFieldInput(checkboxId, inputId){
    const checkbox = document.getElementById(checkboxId);
    const input = document.getElementById(inputId);
    if(checkbox && input){
      checkbox.addEventListener('change', () => {
        input.disabled = !checkbox.checked;
        if(!checkbox.checked) input.value = '';
      });
    }
  }

  const unitDataset = [
    // Main Hotel - group_1 (4 units)
    {
      id:'HR-101',name:'Deluxe King Room',type:'Hotel Room',groupId:'group_1',status:'Active',
      area:45,maxGuests:2,nightlyRate:250,parking:true,checkInHour:14,checkOutHour:12,
      shortDescription:'Spacious room with king bed and city view',
      longDescription:'Modern hotel room with premium bedding, flat-screen TV, and contemporary design.',
      features:['WiFi','Smart TV','Workspace','Air Conditioning'],
      pool:{has:false,specs:''},garden:{has:false,specs:''},kitchen:{has:false,appliances:[]},
      bedrooms:[{name:'Bedroom',bed:'King',details:'Premium mattress'}],toilets:[{type:'Full',details:'Modern bathroom'}],
      media:{featured:'https://images.unsplash.com/photo-1631049307038-da0ec505d9ef?auto=format&fit=crop&w=900&q=80',gallery:[],videos:[]},
      pricing:{weekdayRates:{mon:220,tue:220,wed:240,thu:250,fri:280,sat:280,sun:240},specialDates:[{date:'2025-11-01',price:300,note:'Opening'},{date:'2025-12-25',price:320,note:'Christmas'}]},
      activity:'Regular bookings'
    },
    {
      id:'HR-102',name:'Twin Bedroom Suite',type:'Hotel Room',groupId:'group_1',status:'Active',
      area:50,maxGuests:3,nightlyRate:280,parking:true,checkInHour:14,checkOutHour:12,
      shortDescription:'Suite with twin beds and living area',
      longDescription:'Comfortable suite ideal for families with separate living area and modern amenities.',
      features:['WiFi','Smart TV','Mini Bar','Safe'],
      pool:{has:false,specs:''},garden:{has:false,specs:''},kitchen:{has:false,appliances:[]},
      bedrooms:[{name:'Bedroom',bed:'Twin',details:'Comfortable beds'}],toilets:[{type:'Full',details:'Full bathroom'}],
      media:{featured:'https://images.unsplash.com/photo-1505691723518-36a5ac3be353?auto=format&fit=crop&w=900&q=80',gallery:[],videos:[]},
      pricing:{weekdayRates:{mon:250,tue:250,wed:270,thu:280,fri:310,sat:310,sun:270},specialDates:[{date:'2025-11-05',price:350,note:'Conference'},{date:'2025-12-20',price:340,note:'Holiday'}]},
      activity:'High occupancy weekends'
    },
    {
      id:'HR-103',name:'Executive Suite',type:'Hotel Room',groupId:'group_1',status:'Active',
      area:65,maxGuests:4,nightlyRate:350,parking:true,checkInHour:14,checkOutHour:12,
      shortDescription:'Premium suite with executive amenities',
      longDescription:'Luxury suite with executive lounge access, premium bedding, and exclusive services.',
      features:['WiFi','Smart TV','Executive Lounge','Concierge'],
      pool:{has:false,specs:''},garden:{has:false,specs:''},kitchen:{has:false,appliances:[]},
      bedrooms:[{name:'Master',bed:'King',details:'Luxury bedding'},{name:'Guest',bed:'Queen',details:'Comfortable'}],toilets:[{type:'Full',details:'Spa-like bathroom'}],
      media:{featured:'https://images.unsplash.com/photo-1631049307038-da0ec505d9ef?auto=format&fit=crop&w=900&q=80',gallery:[],videos:[]},
      pricing:{weekdayRates:{mon:300,tue:300,wed:320,thu:350,fri:400,sat:400,sun:320},specialDates:[{date:'2025-11-10',price:450,note:'Corporate'},{date:'2025-12-31',price:500,note:'New Year'}]},
      activity:'Corporate clients'
    },
    {
      id:'HR-104',name:'Family Room',type:'Hotel Room',groupId:'group_1',status:'Active',
      area:60,maxGuests:5,nightlyRate:310,parking:true,checkInHour:14,checkOutHour:12,
      shortDescription:'Spacious room designed for families',
      longDescription:'Family-friendly room with multiple beds, play area access, and kid-friendly amenities.',
      features:['WiFi','Smart TV','Kids Welcome','Game Consoles'],
      pool:{has:false,specs:''},garden:{has:false,specs:''},kitchen:{has:false,appliances:[]},
      bedrooms:[{name:'Master',bed:'Queen',details:'Parents'},{name:'Kids',bed:'Bunk',details:'Children'}],toilets:[{type:'Full',details:'Family bathroom'}],
      media:{featured:'https://images.unsplash.com/photo-1505691723518-36a5ac3be353?auto=format&fit=crop&w=900&q=80',gallery:[],videos:[]},
      pricing:{weekdayRates:{mon:270,tue:270,wed:290,thu:310,fri:350,sat:350,sun:290},specialDates:[{date:'2025-11-20',price:380,note:'Family event'},{date:'2025-12-26',price:370,note:'Holiday break'}]},
      activity:'Family holidays'
    },
    // Chalets Collection - group_2 (4 units)
    {
      id:'CH-201',name:'Desert Escape Chalet',type:'Chalet',groupId:'group_2',status:'Active',
      area:200,maxGuests:6,nightlyRate:650,parking:true,checkInHour:15,checkOutHour:11,
      shortDescription:'Cozy chalet with desert ambiance',
      longDescription:'Intimate desert chalet with private pool, garden, and traditional design elements.',
      features:['WiFi','Smart TV','BBQ Area','Fire Pit'],
      pool:{has:true,specs:'Private pool 6x4m'},garden:{has:true,specs:'Desert garden 150m²'},kitchen:{has:true,appliances:['Refrigerator','Oven','Microwave']},
      bedrooms:[{name:'Master',bed:'King',details:'Terrace access'},{name:'Guest',bed:'Queen',details:'Garden view'}],toilets:[{type:'Full',details:'Modern bathroom'}],
      media:{featured:'https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?auto=format&fit=crop&w=900&q=80',gallery:[],videos:[]},
      pricing:{weekdayRates:{mon:550,tue:550,wed:600,thu:650,fri:750,sat:750,sun:600},specialDates:[{date:'2025-11-18',price:800,note:'Founding Day'},{date:'2025-12-24',price:850,note:'Christmas'}]},
      activity:'Popular weekends'
    },
    {
      id:'CH-202',name:'Luxury Mountain Villa',type:'Chalet',groupId:'group_2',status:'Active',
      area:280,maxGuests:8,nightlyRate:900,parking:true,checkInHour:15,checkOutHour:11,
      shortDescription:'Premium villa with panoramic views',
      longDescription:'Stunning villa featuring infinity pool, spa facilities, and breathtaking mountain views.',
      features:['WiFi','Smart TV','Spa & Sauna','Yoga Studio'],
      pool:{has:true,specs:'Infinity pool with lighting'},garden:{has:true,specs:'Manicured garden 300m²'},kitchen:{has:true,appliances:['Refrigerator','Oven','Dishwasher','Wine Cooler']},
      bedrooms:[{name:'Master Suite',bed:'King',details:'Spa bath'},{name:'Suite 2',bed:'Queen',details:'View'},{name:'Suite 3',bed:'Twin',details:'Guest'}],toilets:[{type:'Full',details:'Marble bathroom'},{type:'Full',details:'Ensuite'},{type:'Half',details:'Guest'}],
      media:{featured:'https://images.unsplash.com/photo-1613395877344-13d4a8e0d049?auto=format&fit=crop&w=900&q=80',gallery:[],videos:[]},
      pricing:{weekdayRates:{mon:800,tue:800,wed:850,thu:900,fri:1050,sat:1050,sun:880},specialDates:[{date:'2025-11-23',price:1150,note:'Thanksgiving'},{date:'2026-01-01',price:1300,note:'New Year'}]},
      activity:'Luxury travelers'
    },
    {
      id:'CH-203',name:'Garden Oasis Resort',type:'Chalet',groupId:'group_2',status:'Active',
      area:320,maxGuests:10,nightlyRate:1000,parking:true,checkInHour:15,checkOutHour:11,
      shortDescription:'Expansive resort chalet for groups',
      longDescription:'Large property perfect for group events with multiple lounges, game room, and extensive grounds.',
      features:['WiFi','Smart TV','Game Room','Outdoor Cinema'],
      pool:{has:true,specs:'Large pool with shallow area'},garden:{has:true,specs:'Resort gardens 400m²'},kitchen:{has:true,appliances:['Refrigerator','Oven','Dishwasher','Wine Cooler']},
      bedrooms:[{name:'Master',bed:'King',details:'Primary'},{name:'Suite 2',bed:'Queen',details:'Ensuite'},{name:'Suite 3',bed:'Queen',details:'Ensuite'},{name:'Dorm',bed:'4 Single',details:'Shared'}],toilets:[{type:'Full',details:'Main'},{type:'Full',details:'Master'},{type:'Half',details:'Guest'}],
      media:{featured:'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?auto=format&fit=crop&w=900&q=80',gallery:[],videos:[]},
      pricing:{weekdayRates:{mon:850,tue:850,wed:900,thu:950,fri:1150,sat:1150,sun:980},specialDates:[{date:'2025-11-18',price:1300,note:'Group events'},{date:'2025-12-20',price:1350,note:'Holiday'}]},
      activity:'Group gatherings'
    },
    {
      id:'CH-204',name:'Romantic Starlight Chalet',type:'Chalet',groupId:'group_2',status:'Active',
      area:220,maxGuests:4,nightlyRate:700,parking:true,checkInHour:15,checkOutHour:11,
      shortDescription:'Intimate chalet for couples',
      longDescription:'Romantic getaway with couples amenities, wine cellar, massage room, and star-gazing pavilion.',
      features:['WiFi','Smart TV','Wine Cellar','Massage Room'],
      pool:{has:true,specs:'Infinity pool 5x4m'},garden:{has:true,specs:'Romantic garden 200m²'},kitchen:{has:true,appliances:['Refrigerator','Oven','Microwave']},
      bedrooms:[{name:'Master',bed:'King',details:'Spa tub view'},{name:'Guest',bed:'Queen',details:'Separate entrance'}],toilets:[{type:'Full',details:'Luxury bathroom'},{type:'Half',details:'Guest'}],
      media:{featured:'https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?auto=format&fit=crop&w=900&q=80',gallery:[],videos:[]},
      pricing:{weekdayRates:{mon:600,tue:600,wed:650,thu:700,fri:820,sat:820,sun:720},specialDates:[{date:'2025-02-14',price:950,note:'Valentines'},{date:'2025-12-24',price:900,note:'Christmas'}]},
      activity:'Anniversaries & honeymoons'
    }
  ];

    function getDefaultWeekdayRates(base){
      const roundedBase = Math.max(Number(base)||0,0);
      return weekdayKeys.reduce((acc,key)=>{acc[key]=roundedBase;return acc;},{});
    }

    function ensurePricingStructure(unit){
      if(!unit.pricing){
        unit.pricing = {weekdayRates:getDefaultWeekdayRates(unit.nightlyRate||0),specialDates:[]};
      } else {
        unit.pricing.weekdayRates = {...getDefaultWeekdayRates(unit.nightlyRate||0),...unit.pricing.weekdayRates};
        unit.pricing.specialDates = Array.isArray(unit.pricing.specialDates)? unit.pricing.specialDates : [];
      }
    }

    function averageWeekdayRate(rates){
      const values = weekdayKeys.map(key=>Number(rates?.[key]||0));
      const total = values.reduce((sum,val)=>sum+val,0);
      return values.length? Math.round(total/values.length):0;
    }

    function formatRateSummary(unit){
      const rates = unit.pricing?.weekdayRates || getDefaultWeekdayRates(unit.nightlyRate||0);
      const values = weekdayKeys.map(key=>Number(rates[key]||0));
      const min = Math.min(...values);
      const max = Math.max(...values);
      if(min===max){
        return `$${min.toLocaleString()}`;
      }
      return `$${min.toLocaleString()}–$${max.toLocaleString()}`;
    }

    function formatCurrency(value){
      return `$${Number(value||0).toLocaleString()}`;
    }

    function syncAverageRateToField(){
      draftUnit.nightlyRate = averageWeekdayRate(draftUnit.pricing.weekdayRates);
      document.getElementById('nightlyRate').value = draftUnit.nightlyRate || '';
    }

    unitDataset.forEach(unit=>{
      ensurePricingStructure(unit);
      unit.nightlyRate = averageWeekdayRate(unit.pricing.weekdayRates);
    });

    const filters = {search:'',status:'all'};
    let draftUnit = null;
    let formMode = 'create';

    const amenityOptions = ['WiFi','Smart TV','Workspace','BBQ Area','Outdoor Cinema','Fire Pit','Security Cameras','Concierge','Private Chef'];
    const kitchenAppliances = ['Refrigerator','Oven','Microwave','Dishwasher','Coffee Maker','Air Fryer'];

    const unitsTableBody = document.getElementById('unitsTableBody');
    const amenityTagList = document.getElementById('amenityTagList');
    const pricingOverridesList = document.getElementById('pricingOverridesList');

    function renderTable(){
      const filtered = unitDataset.filter(unit=>{
        const matchesSearch = filters.search? (unit.name.toLowerCase().includes(filters.search) || unit.id.toLowerCase().includes(filters.search)):true;
        const matchesStatus = filters.status==='all'? true : unit.status===filters.status;
        const matchesGroup = !unit.groupId || unit.groupId === currentGroupId;
        return matchesSearch && matchesStatus && matchesGroup;
      });

      unitsTableBody.innerHTML='';
      if(!filtered.length){
        unitsTableBody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><i class="fa-regular fa-face-smile"></i><div style="margin-top:8px">No units match your filters. Try adjusting the search or status.</div></div></td></tr>`;
        return;
      }

      filtered.forEach(unit=>{
        const tr=document.createElement('tr');
        const statusClass = unit.status.toLowerCase();
        tr.innerHTML = `
          <td><div class="unit-cell"><div class="unit-name">${unit.name}</div><div class="unit-meta">${unit.id}</div></div></td>
          <td>${unit.type}</td>
          <td>${unit.maxGuests}</td>
          <td>$${unit.nightlyRate.toLocaleString()}<div class="rate-sub">Range ${formatRateSummary(unit)}</div></td>
          <td><span class="status-pill ${statusClass}"><span class="dot"></span>${unit.status}</span></td>
          <td><div class="actions"><button class="icon-btn" data-action="edit" data-id="${unit.id}" title="Edit"><i class="fa-regular fa-pen-to-square"></i></button><button class="icon-btn danger" data-action="delete" data-id="${unit.id}" title="Delete"><i class="fa-regular fa-trash-can"></i></button></div></td>
        `;
        unitsTableBody.appendChild(tr);
      });

      unitsTableBody.querySelectorAll('button[data-action]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const id=btn.dataset.id;
          if(btn.dataset.action==='edit'){openSheet('edit',id);} else {
            if(confirm('Delete this unit? This cannot be undone in the prototype.')){
              const index = unitDataset.findIndex(u=>u.id===id);
              if(index>=0){unitDataset.splice(index,1);renderTable();updateSummaries();refreshSidebarData();}
            }
          }
        });
      });
    }

    function updateSummaries(){
      const groupUnits = unitDataset.filter(u=>!u.groupId || u.groupId === currentGroupId);
      const total = groupUnits.length;
      const active = groupUnits.filter(u=>u.status==='Active').length;
      const maintenance = groupUnits.filter(u=>u.status==='Maintenance').length;
      const avgRate = total? Math.round(groupUnits.reduce((sum,u)=>sum+Number(u.nightlyRate||0),0)/total):0;
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statActive').textContent = active;
      document.getElementById('statMaintenance').textContent = maintenance;
      document.getElementById('statADR').textContent = `$${avgRate.toLocaleString()}`;
    }

    function refreshSidebarData(){
      // Amenities tag cloud
      const groupUnits = unitDataset.filter(u=>!u.groupId || u.groupId === currentGroupId);
      const counts = {};
      groupUnits.forEach(unit=>{
        (unit.features||[]).forEach(feature=>{counts[feature]=(counts[feature]||0)+1;});
      });
      const entries = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,12);
      amenityTagList.innerHTML='';
      if(!entries.length){
        amenityTagList.innerHTML='<span class="tag">No amenities listed yet</span>';
      } else {
        entries.forEach(([label,count])=>{
          const span=document.createElement('span');
          span.className='tag';
          span.textContent=`${label} · ${count}`;
          amenityTagList.appendChild(span);
        });
      }

      const overrides=[];
      groupUnits.forEach(unit=>{
        (unit.pricing?.specialDates||[]).forEach(entry=>{
          if(entry.date){
            overrides.push({unit:unit.name,id:unit.id,date:entry.date,price:Number(entry.price||0),note:entry.note});
          }
        });
      });
      overrides.sort((a,b)=>new Date(a.date)-new Date(b.date));
      pricingOverridesList.innerHTML='';
      if(!overrides.length){
        const li=document.createElement('li');
        li.textContent='No overrides scheduled yet.';
        pricingOverridesList.appendChild(li);
      } else {
        overrides.slice(0,5).forEach(item=>{
          const li=document.createElement('li');
          li.style.display='flex';
          li.style.flexDirection='column';
          li.style.gap='2px';
          li.innerHTML=`<span><strong>${item.unit}</strong> · ${item.date}</span><span class="rate-sub">${formatCurrency(item.price)}${item.note?` · ${item.note}`:''}</span>`;
          pricingOverridesList.appendChild(li);
        });
      }
    }

    // Sheet helpers
    const sheetBackdrop = document.getElementById('sheetBackdrop');
    const sheetTitle = document.getElementById('sheetTitle');
    const sheetSubtitle = document.getElementById('sheetSubtitle');
    const tabs = document.querySelectorAll('.tab');
    const tabPanels = document.querySelectorAll('.tab-panel');

    tabs.forEach(tab=>{
      tab.addEventListener('click',()=>{
        tabs.forEach(t=>t.classList.remove('active'));
        tabPanels.forEach(p=>p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    document.getElementById('addUnitBtn').addEventListener('click',()=>openSheet('create'));
    document.getElementById('closeSheet').addEventListener('click',closeSheet);
    document.getElementById('cancelSheet').addEventListener('click',closeSheet);

    function openSheet(mode,id){
      formMode = mode;
      if(mode==='edit'){
        const unit = unitDataset.find(u=>u.id===id);
        if(!unit) return;
        draftUnit = JSON.parse(JSON.stringify(unit));
        ensurePricingStructure(draftUnit);
        sheetTitle.textContent = 'Edit Unit';
        sheetSubtitle.textContent = `Updating ${unit.name} (${unit.id})`;
      } else {
        draftUnit = {
          id:generateUnitId(),
          name:'',type:'Chalet',groupId:currentGroupId,status:'Active',area:'',maxGuests:'',nightlyRate:'',parking:false,checkInHour:14,checkOutHour:12,
          shortDescription:'',longDescription:'',features:[],pool:{has:false,specs:''},garden:{has:false,specs:''},
          kitchen:{has:false,appliances:[]},bedrooms:[],toilets:[],media:{featured:'',gallery:[],videos:[]},
          pricing:{weekdayRates:getDefaultWeekdayRates(0),specialDates:[]},
          policy:'',
          activity:'New unit added just now'
        };
        ensurePricingStructure(draftUnit);
        sheetTitle.textContent = 'Add Unit';
        sheetSubtitle.textContent = 'Complete the form to create a new unit.';
      }
      populateForm();
      sheetBackdrop.classList.add('show');
      document.body.style.overflow='hidden';
    }

    function closeSheet(){
      sheetBackdrop.classList.remove('show');
      document.body.style.overflow='';
    }

    function populateForm(){
      ensurePricingStructure(draftUnit);
      document.getElementById('unitName').value = draftUnit.name || '';
      document.getElementById('unitType').value = draftUnit.type || 'Chalet';
      document.getElementById('unitStatus').value = draftUnit.status || 'Active';
      document.getElementById('unitArea').value = draftUnit.area || '';
      document.getElementById('maxGuests').value = draftUnit.maxGuests || '';
      document.getElementById('nightlyRate').value = draftUnit.nightlyRate || '';
      document.getElementById('parkingToggle').checked = !!draftUnit.parking;
      document.getElementById('checkInHour').value = draftUnit.checkInHour || '';
      document.getElementById('checkOutHour').value = draftUnit.checkOutHour || '';
      document.getElementById('shortDescription').value = draftUnit.shortDescription || '';
      document.getElementById('longDescription').value = draftUnit.longDescription || '';

      renderWeekdayPricing();
      renderOverrides();

      renderFeatureOptions();
      document.getElementById('poolToggle').checked = !!draftUnit.pool?.has;
      document.getElementById('poolSpecs').value = draftUnit.pool?.specs || '';
      document.getElementById('poolSpecs').disabled = !draftUnit.pool?.has;

      document.getElementById('gardenToggle').checked = !!draftUnit.garden?.has;
      document.getElementById('gardenSpecs').value = draftUnit.garden?.specs || '';
      document.getElementById('gardenSpecs').disabled = !draftUnit.garden?.has;

      document.getElementById('kitchenToggle').checked = !!draftUnit.kitchen?.has;
      renderKitchenOptions();

      renderBedrooms();
      renderToilets();

      renderMediaPreviews();

      // Populate policy field
      document.getElementById('policyText').value = draftUnit.policy || '';

      // Initialize property-specific fields
      updatePropertyFields();

      // Populate Saudi Arabia property-specific fields
      if(draftUnit.type === 'Chalet'){
        document.getElementById('chaletPool').checked = !!draftUnit.chaletPool?.has;
        document.getElementById('chaletPoolSpecs').value = draftUnit.chaletPool?.specs || '';
        document.getElementById('chaletPoolSpecs').disabled = !draftUnit.chaletPool?.has;
        document.getElementById('chaletGarden').checked = !!draftUnit.chaletGarden?.has;
        document.getElementById('chaletGardenSpecs').value = draftUnit.chaletGarden?.specs || '';
        document.getElementById('chaletGardenSpecs').disabled = !draftUnit.chaletGarden?.has;
        document.getElementById('chaletAreas').value = draftUnit.entertainmentAreas || '';
      } else if(draftUnit.type === 'Hotel Room'){
        document.getElementById('floorNumber').value = draftUnit.floorNumber || '';
        document.getElementById('roomView').value = draftUnit.roomView || '';
        document.getElementById('starRating').value = draftUnit.starRating || '';
        document.getElementById('amenitiesHotel').value = draftUnit.hotelAmenities || '';
      } else if(draftUnit.type === 'Hotel Apartment'){
        document.getElementById('apartmentFloor').value = draftUnit.apartmentFloor || '';
        document.getElementById('apartmentView').value = draftUnit.apartmentView || '';
        document.getElementById('roomSize').value = draftUnit.roomSize || '';
      }

      // Setup toggle listeners for chalet fields
      toggleFieldInput('chaletPool', 'chaletPoolSpecs');
      toggleFieldInput('chaletGarden', 'chaletGardenSpecs');
    }

    function renderWeekdayPricing(){
      const container=document.getElementById('weekdayPricingGrid');
      if(!container || !draftUnit?.pricing) return;
      container.innerHTML='';
      weekdayKeys.forEach(key=>{
        const card=document.createElement('div');
        card.className='weekday-card';
        const value=Number(draftUnit.pricing.weekdayRates?.[key]||0);
        card.innerHTML=`<div class="weekday-label">${weekdayLabels[key]}</div><input type="number" min="0" data-day="${key}" value="${value}">`;
        const input=card.querySelector('input');
        input.addEventListener('input',()=>{
          draftUnit.pricing.weekdayRates[key] = Number(input.value)||0;
        });
        input.addEventListener('blur',()=>{
          syncAverageRateToField();
        });
        container.appendChild(card);
      });
      syncAverageRateToField();
    }

    function renderOverrides(){
      const container=document.getElementById('overrideContainer');
      if(!container || !draftUnit?.pricing) return;
      container.innerHTML='';
      if(!draftUnit.pricing.specialDates.length){
        container.innerHTML='<div class="empty-state" style="padding:14px">No special pricing configured.</div>';
        return;
      }
      draftUnit.pricing.specialDates.forEach((entry,index)=>{
        const card=document.createElement('div');
        card.className='override-card';
        card.innerHTML=`
          <div class="override-meta">
            <div class="field"><label>Date</label><input type="date" value="${entry.date||''}" data-field="date"></div>
            <div class="field"><label>Price</label><input type="number" min="0" value="${entry.price||0}" data-field="price"></div>
          </div>
          <div class="field"><label>Notes</label><input type="text" value="${entry.note||''}" data-field="note"></div>
          <div class="card-actions"><button class="icon-btn danger" data-remove="${index}" title="Remove"><i class="fa-solid fa-xmark"></i></button></div>
        `;
        const dateInput=card.querySelector('input[data-field="date"]');
        const priceInput=card.querySelector('input[data-field="price"]');
        const noteInput=card.querySelector('input[data-field="note"]');
        dateInput.addEventListener('change',()=>{draftUnit.pricing.specialDates[index].date=dateInput.value;});
        priceInput.addEventListener('input',()=>{draftUnit.pricing.specialDates[index].price=Number(priceInput.value)||0;});
        noteInput.addEventListener('input',()=>{draftUnit.pricing.specialDates[index].note=noteInput.value;});
        card.querySelector('[data-remove]').addEventListener('click',()=>{
          draftUnit.pricing.specialDates.splice(index,1);
          renderOverrides();
        });
        container.appendChild(card);
      });
    }

    function renderFeatureOptions(){
      const container=document.getElementById('featureCheckboxes');
      container.innerHTML='';
      amenityOptions.forEach(option=>{
        const id=`feature-${option.replace(/\s+/g,'-')}`;
        const label=document.createElement('label');
        label.style.display='flex';
        label.style.alignItems='center';
        label.style.gap='6px';
        label.style.fontWeight='500';
        label.innerHTML=`<input type="checkbox" value="${option}" id="${id}"> ${option}`;
        const input=label.querySelector('input');
        input.checked = draftUnit.features?.includes(option);
        input.addEventListener('change',()=>{
          if(input.checked){
            if(!draftUnit.features.includes(option)) draftUnit.features.push(option);
          } else {
            draftUnit.features = draftUnit.features.filter(f=>f!==option);
          }
        });
        container.appendChild(label);
      });
    }

    function renderKitchenOptions(){
      const container=document.getElementById('kitchenOptions');
      container.innerHTML='';
      const hasKitchen=document.getElementById('kitchenToggle').checked;
      draftUnit.kitchen.has = hasKitchen;
      kitchenAppliances.forEach(appliance=>{
        const label=document.createElement('label');
        label.style.display='flex';label.style.alignItems='center';label.style.gap='6px';label.style.fontWeight='500';label.style.opacity = hasKitchen?1:0.5;
        label.innerHTML=`<input type="checkbox" value="${appliance}" ${hasKitchen?'':'disabled'}> ${appliance}`;
        const input=label.querySelector('input');
        input.checked = draftUnit.kitchen.appliances?.includes(appliance);
        input.addEventListener('change',()=>{
          if(input.checked){
            if(!draftUnit.kitchen.appliances.includes(appliance)) draftUnit.kitchen.appliances.push(appliance);
          } else {
            draftUnit.kitchen.appliances = draftUnit.kitchen.appliances.filter(item=>item!==appliance);
          }
        });
        container.appendChild(label);
      });
    }

    document.getElementById('poolToggle').addEventListener('change',e=>{
      draftUnit.pool.has = e.target.checked;
      document.getElementById('poolSpecs').disabled = !e.target.checked;
      if(!e.target.checked) document.getElementById('poolSpecs').value='';
    });
    document.getElementById('gardenToggle').addEventListener('change',e=>{
      draftUnit.garden.has = e.target.checked;
      document.getElementById('gardenSpecs').disabled = !e.target.checked;
      if(!e.target.checked) document.getElementById('gardenSpecs').value='';
    });
    document.getElementById('kitchenToggle').addEventListener('change',()=>renderKitchenOptions());

    // Policy field listener
    document.getElementById('policyText').addEventListener('input', e=>{
      draftUnit.policy = e.target.value;
    });

    function renderBedrooms(){
      const container=document.getElementById('bedroomsContainer');
      container.innerHTML='';
      (draftUnit.bedrooms||[]).forEach((room,index)=>{
        const card=document.createElement('div');
        card.className='dynamic-card';
        card.innerHTML=`
          <div class="grid-2">
            <div class="field"><label>Room Name</label><input type="text" value="${room.name||''}" data-field="name"></div>
            <div class="field"><label>Bed Type</label><input type="text" value="${room.bed||''}" data-field="bed"></div>
          </div>
          <div class="field"><label>Details</label><input type="text" value="${room.details||''}" data-field="details"></div>
          <div class="card-actions"><button class="icon-btn danger" data-remove="${index}" title="Remove"><i class="fa-solid fa-xmark"></i></button></div>
        `;
        card.querySelectorAll('input').forEach(input=>{
          input.addEventListener('input',()=>{
            draftUnit.bedrooms[index][input.dataset.field]=input.value;
          });
        });
        card.querySelector('[data-remove]').addEventListener('click',()=>{
          draftUnit.bedrooms.splice(index,1);
          renderBedrooms();
        });
        container.appendChild(card);
      });
      if(!draftUnit.bedrooms.length){
        container.innerHTML='<div class="empty-state" style="padding:14px">No bedrooms added yet.</div>';
      }
    }

    function renderToilets(){
      const container=document.getElementById('toiletsContainer');
      container.innerHTML='';
      (draftUnit.toilets||[]).forEach((bath,index)=>{
        const card=document.createElement('div');
        card.className='dynamic-card';
        card.innerHTML=`
          <div class="grid-2">
            <div class="field"><label>Type</label><select data-field="type"><option value="Full">Full</option><option value="Half">Half</option></select></div>
            <div class="field"><label>Details</label><input type="text" value="${bath.details||''}" data-field="details"></div>
          </div>
          <div class="card-actions"><button class="icon-btn danger" data-remove="${index}" title="Remove"><i class="fa-solid fa-xmark"></i></button></div>
        `;
        const select=card.querySelector('select');
        select.value = bath.type || 'Full';
        select.addEventListener('change',()=>{draftUnit.toilets[index].type=select.value;});
        const input=card.querySelector('input');
        input.addEventListener('input',()=>{draftUnit.toilets[index].details=input.value;});
        card.querySelector('[data-remove]').addEventListener('click',()=>{
          draftUnit.toilets.splice(index,1);
          renderToilets();
        });
        container.appendChild(card);
      });
      if(!draftUnit.toilets.length){
        container.innerHTML='<div class="empty-state" style="padding:14px">No bathrooms added yet.</div>';
      }
    }

    document.getElementById('addBedroomBtn').addEventListener('click',()=>{
      draftUnit.bedrooms.push({name:'',bed:'',details:''});
      renderBedrooms();
    });
    document.getElementById('addToiletBtn').addEventListener('click',()=>{
      draftUnit.toilets.push({type:'Full',details:''});
      renderToilets();
    });
    document.getElementById('addOverrideBtn').addEventListener('click',()=>{
      if(!draftUnit) return;
      if(!draftUnit?.pricing){
        ensurePricingStructure(draftUnit);
      }
      draftUnit.pricing.specialDates.push({date:'',price:0,note:''});
      renderOverrides();
    });

    // Media functions
    function renderMediaPreviews(){
      renderFeaturedImagePreview();
      renderGalleryImages();
      renderVideos();
    }

    function renderFeaturedImagePreview(){
      const container = document.getElementById('featuredImagePreview');
      container.innerHTML = '';
      if(draftUnit.media?.featured){
        const card = document.createElement('div');
        card.className = 'media-card';
        card.innerHTML = `
          <div class="preview">
            <img src="${draftUnit.media.featured}" alt="Featured image">
          </div>
          <div class="info">
            <div class="info-name">Featured Image</div>
            <div class="actions">
              <button class="icon-btn danger" type="button" data-action="remove-featured" title="Remove"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
        `;
        card.querySelector('[data-action="remove-featured"]').addEventListener('click',()=>{
          draftUnit.media.featured = '';
          renderFeaturedImagePreview();
        });
        container.appendChild(card);
      } else {
        container.innerHTML = '<div class="empty-state" style="padding:14px">No featured image uploaded.</div>';
      }
    }

    function renderGalleryImages(){
      const container = document.getElementById('galleryImagesContainer');
      container.innerHTML = '';
      if(!draftUnit.media?.gallery?.length){
        container.innerHTML = '<div class="empty-state" style="padding:14px">No gallery images uploaded yet.</div>';
        return;
      }
      draftUnit.media.gallery.forEach((image,index)=>{
        const card = document.createElement('div');
        card.className = 'media-card';
        card.innerHTML = `
          <div class="preview">
            <img src="${image}" alt="Gallery image ${index+1}">
          </div>
          <div class="info">
            <div class="info-name">Image ${index+1}</div>
            <div class="actions">
              <button class="icon-btn danger" type="button" data-action="remove-gallery" data-index="${index}" title="Remove"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
        `;
        card.querySelector('[data-action="remove-gallery"]').addEventListener('click',()=>{
          draftUnit.media.gallery.splice(index,1);
          renderGalleryImages();
        });
        container.appendChild(card);
      });
    }

    function renderVideos(){
      const container = document.getElementById('videosContainer');
      container.innerHTML = '';
      if(!draftUnit.media?.videos?.length){
        container.innerHTML = '<div class="empty-state" style="padding:14px">No videos uploaded yet.</div>';
        return;
      }
      draftUnit.media.videos.forEach((video,index)=>{
        const card = document.createElement('div');
        card.className = 'media-card';
        card.innerHTML = `
          <div class="preview">
            <i class="fa-solid fa-film"></i>
          </div>
          <div class="info">
            <div class="info-name">${video.name || `Video ${index+1}`}</div>
            <div class="actions">
              <button class="icon-btn danger" type="button" data-action="remove-video" data-index="${index}" title="Remove"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
        `;
        card.querySelector('[data-action="remove-video"]').addEventListener('click',()=>{
          draftUnit.media.videos.splice(index,1);
          renderVideos();
        });
        container.appendChild(card);
      });
    }

    document.getElementById('featuredImageUpload').addEventListener('change',()=>{
      const file = document.getElementById('featuredImageUpload').files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = (e)=>{
          draftUnit.media.featured = e.target.result;
          renderFeaturedImagePreview();
          document.getElementById('featuredImageUpload').value = '';
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('addGalleryImageBtn').addEventListener('click',()=>{
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.addEventListener('change',()=>{
        const file = input.files[0];
        if(file){
          const reader = new FileReader();
          reader.onload = (e)=>{
            draftUnit.media.gallery.push(e.target.result);
            renderGalleryImages();
          };
          reader.readAsDataURL(file);
        }
      });
      input.click();
    });

    document.getElementById('addVideoBtn').addEventListener('click',()=>{
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'video/*';
      input.addEventListener('change',()=>{
        const file = input.files[0];
        if(file){
          const reader = new FileReader();
          reader.onload = (e)=>{
            draftUnit.media.videos.push({name:file.name,data:e.target.result});
            renderVideos();
          };
          reader.readAsDataURL(file);
        }
      });
      input.click();
    });

    const nightlyRateInput=document.getElementById('nightlyRate');
    nightlyRateInput.addEventListener('change',()=>{
      if(!draftUnit) return;
      const value=Number(nightlyRateInput.value)||0;
      draftUnit.nightlyRate = value;
      if(draftUnit.pricing){
        const rates=draftUnit.pricing.weekdayRates;
        const firstValue=rates[weekdayKeys[0]];
        const uniform = weekdayKeys.every(key=>rates[key]===firstValue);
        if(uniform){
          weekdayKeys.forEach(key=>{draftUnit.pricing.weekdayRates[key]=value;});
          renderWeekdayPricing();
        }
      }
    });

    document.getElementById('saveUnitBtn').addEventListener('click',()=>{
      draftUnit.name = document.getElementById('unitName').value.trim();
      draftUnit.type = document.getElementById('unitType').value;
      draftUnit.status = document.getElementById('unitStatus').value;
      draftUnit.area = Number(document.getElementById('unitArea').value) || '';
      draftUnit.maxGuests = Number(document.getElementById('maxGuests').value) || '';
      draftUnit.nightlyRate = Number(document.getElementById('nightlyRate').value) || 0;
      draftUnit.parking = document.getElementById('parkingToggle').checked;
      draftUnit.checkInHour = Number(document.getElementById('checkInHour').value) || '';
      draftUnit.checkOutHour = Number(document.getElementById('checkOutHour').value) || '';
      draftUnit.shortDescription = document.getElementById('shortDescription').value.trim();
      draftUnit.longDescription = document.getElementById('longDescription').value.trim();
      draftUnit.pool.specs = document.getElementById('poolSpecs').value.trim();
      draftUnit.garden.specs = document.getElementById('gardenSpecs').value.trim();
      if(!draftUnit.kitchen.has) draftUnit.kitchen.appliances=[];

      // Save Saudi Arabia property-specific fields
      if(draftUnit.type === 'Chalet'){
        draftUnit.chaletPool = {
          has: document.getElementById('chaletPool').checked,
          specs: document.getElementById('chaletPoolSpecs').value.trim()
        };
        draftUnit.chaletGarden = {
          has: document.getElementById('chaletGarden').checked,
          specs: document.getElementById('chaletGardenSpecs').value.trim()
        };
        draftUnit.entertainmentAreas = document.getElementById('chaletAreas').value.trim();
      } else if(draftUnit.type === 'Hotel Room'){
        draftUnit.floorNumber = Number(document.getElementById('floorNumber').value) || '';
        draftUnit.roomView = document.getElementById('roomView').value;
        draftUnit.starRating = document.getElementById('starRating').value;
        draftUnit.hotelAmenities = document.getElementById('amenitiesHotel').value.trim();
      } else if(draftUnit.type === 'Hotel Apartment'){
        draftUnit.apartmentFloor = Number(document.getElementById('apartmentFloor').value) || '';
        draftUnit.apartmentView = document.getElementById('apartmentView').value;
        draftUnit.roomSize = document.getElementById('roomSize').value;
      }

      if(draftUnit.pricing){
        draftUnit.pricing.specialDates = draftUnit.pricing.specialDates.filter(entry=>entry.date);
        draftUnit.nightlyRate = averageWeekdayRate(draftUnit.pricing.weekdayRates);
      }

      if(!draftUnit.name){alert('Please enter a unit name.');return;}

      if(formMode==='edit'){
        const index = unitDataset.findIndex(u=>u.id===draftUnit.id);
        if(index>=0){unitDataset[index]=draftUnit;}
      } else {
        unitDataset.unshift(draftUnit);
      }

      renderTable();
      updateSummaries();
      refreshSidebarData();
      closeSheet();
    });

    function generateUnitId(){
      const prefixOptions=['CH','APT','HR','VL'];
      const prefix=prefixOptions[Math.floor(Math.random()*prefixOptions.length)];
      const number=Math.floor(Math.random()*900+100);
      return `${prefix}-${number}`;
    }

    // Filters
    document.getElementById('searchInput').addEventListener('input',e=>{
      filters.search = e.target.value.trim().toLowerCase();
      renderTable();
    });
    document.getElementById('statusFilter').addEventListener('change',e=>{filters.status=e.target.value;renderTable();});

    // Profile menu mimic
    document.getElementById('profileBtn').addEventListener('click',()=>{
      document.getElementById('profileMenu').classList.toggle('show');
    });
    document.getElementById('profileSettings').addEventListener('click',()=>alert('Open Profile Settings (simulated)'));
    document.getElementById('logoutBtn').addEventListener('click',()=>{
      document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Inter"><div style="text-align:center"><h2>You are logged out</h2><p>Simulation only. Reload to return.</p></div></div>';
    });
    // Nav behaviour
    document.querySelectorAll('.nav-item').forEach(item=>{
      item.addEventListener('click',(e)=>{
        e.preventDefault();
        e.stopPropagation();
        // Get the closest nav-item (in case user clicked child element)
        const navItem = e.target.closest('.nav-item');
        if(!navItem) return;
        
        const link = navItem.dataset.link;
        if(link){
          // Redirect to target page
          const fullPath = getPagePath(link);
          console.log('Navigating to:', fullPath);
          location.href = fullPath;
          return;
        }
        alert('This section is not part of the current prototype.');
      });
    });

    renderTable();
    updateSummaries();
    refreshSidebarData();

    // Language translations
    const translations = {
      en: {
        dashboard: 'Dashboard',
        calendar: 'Calendar',
        units: 'Units',
        website: 'Website Settings',
        aiagent: 'AI Agent',
        completeProfile: 'Complete Profile',
        changePassword: 'Change Password',
        changeEmail: 'Change Email',
        logout: 'Logout',
        edit: 'Edit',
        delete: 'Delete',
        save: 'Save',
        cancel: 'Cancel',
        close: 'Close',
        unitName: 'Unit Name',
        unitType: 'Unit Type',
        status: 'Status',
        area: 'Area (m²)',
        maxGuests: 'Max Guests',
        nightlyRate: 'Nightly Rate',
        active: 'Active',
        inactive: 'Inactive',
        general: 'General',
        pricing: 'Pricing',
        amenities: 'Amenities',
        bedrooms: 'Bedrooms',
        bathrooms: 'Bathrooms',
        media: 'Media',
        description: 'Description',
        shortDescription: 'Short Description',
        longDescription: 'Long Description',
        addUnit: 'Add Unit',
        search: 'Search units or IDs'
      },
      ar: {
        dashboard: 'لوحة التحكم',
        calendar: 'التقويم',
        units: 'الوحدات',
        website: 'إعدادات الموقع',
        aiagent: 'وكيل الذكاء الاصطناعي',
        completeProfile: 'إكمال الملف الشخصي',
        changePassword: 'تغيير كلمة المرور',
        changeEmail: 'تغيير عنوان البريد الإلكتروني',
        logout: 'تسجيل الخروج',
        edit: 'تعديل',
        delete: 'حذف',
        save: 'حفظ',
        cancel: 'إلغاء',
        close: 'إغلاق',
        unitName: 'اسم الوحدة',
        unitType: 'نوع الوحدة',
        status: 'الحالة',
        area: 'المساحة (م²)',
        maxGuests: 'عدد الضيوف الأقصى',
        nightlyRate: 'السعر الليلي',
        active: 'نشط',
        inactive: 'غير نشط',
        general: 'عام',
        pricing: 'التسعير',
        amenities: 'المرافق',
        bedrooms: 'غرف النوم',
        bathrooms: 'الحمامات',
        media: 'الوسائط',
        description: 'الوصف',
        shortDescription: 'وصف قصير',
        longDescription: 'وصف طويل',
        addUnit: 'إضافة وحدة',
        search: 'ابحث عن الوحدات أو المعرفات'
      }
    };
    // Current language
    let currentLanguage = localStorage.getItem('language') || 'en';

    // Current currency
    let currentCurrency = localStorage.getItem('currency') || 'SAR';

    // Set initial language
    function setLanguage(lang){
      currentLanguage = lang;
      localStorage.setItem('language', lang);
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
      applyTranslations();
      updateLanguageButtons();
    }

    // Get translated text
    function t(key){
      return translations[currentLanguage]?.[key] || translations.en[key] || key;
    }

    // Apply translations to all elements with data-i18n attribute
    function applyTranslations(){
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.dataset.i18n;
        el.textContent = t(key);
      });
      // Also translate select options
      document.querySelectorAll('option[data-i18n]').forEach(el=>{
        el.textContent = t(el.dataset.i18n);
      });
      // Apply placeholder translations
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
        el.placeholder = t(el.dataset.i18nPlaceholder);
      });
    }

    // Update language button styles
    function updateLanguageButtons(){
      const enBtn = document.getElementById('langEnglish');
      const arBtn = document.getElementById('langArabic');
      if(currentLanguage === 'en'){
        enBtn.style.color = '#f97316';
        enBtn.style.fontWeight = '600';
        arBtn.style.color = '#64748b';
        arBtn.style.fontWeight = 'normal';
      } else {
        arBtn.style.color = '#f97316';
        arBtn.style.fontWeight = '600';
        enBtn.style.color = '#64748b';
        enBtn.style.fontWeight = 'normal';
      }
    }

    // Language switcher listeners
    document.getElementById('langEnglish').addEventListener('click',()=>{setLanguage('en');});
    document.getElementById('langArabic').addEventListener('click',()=>{setLanguage('ar');});

    // Currency switcher listeners
    function updateCurrencyButtons(){
      const usdBtn = document.getElementById('currencyUSD');
      const sarBtn = document.getElementById('currencySAR');
      const eurBtn = document.getElementById('currencyEUR');
      
      // Reset all buttons
      [usdBtn, sarBtn, eurBtn].forEach(btn => {
        btn.style.color = '#64748b';
        btn.style.fontWeight = 'normal';
      });
      
      // Highlight selected currency
      if(currentCurrency === 'USD') usdBtn.style.color = '#f97316';
      else if(currentCurrency === 'SAR') sarBtn.style.color = '#f97316';
      else if(currentCurrency === 'EUR') eurBtn.style.color = '#f97316';
      
      // Update font weight for active
      const activeBtn = document.getElementById('currency' + currentCurrency);
      if(activeBtn) activeBtn.style.fontWeight = '600';
    }

    function setCurrency(currency){
      currentCurrency = currency;
      localStorage.setItem('currency', currency);
      updateCurrencyButtons();
      renderUnits();
    }

    // Initialize currency buttons
    updateCurrencyButtons();
    document.getElementById('currencyUSD').addEventListener('click', () => { setCurrency('USD'); });
    document.getElementById('currencySAR').addEventListener('click', () => { setCurrency('SAR'); });
    document.getElementById('currencyEUR').addEventListener('click', () => { setCurrency('EUR'); });

    // Navigation handlers - redirect to dashboard.html with tab parameter
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const section = item.dataset.link;
        if (section) {
          window.location.href = section;
        }
      });
    });

    // Initialize language
    setLanguage(currentLanguage);

    // Initialize groups tabs
    renderGroupsTabs();
  </script>
</body>
</html>

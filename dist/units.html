<!doctype html>
<html lang="en">
<head>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<base href="/hospitality-dashboard/dist/">
	<title>Units — Hospitality Booking Admin</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
	<!-- Extracted & Organized CSS Files -->
	<link rel="stylesheet" href="css/variables.css">
	<link rel="stylesheet" href="css/global.css">
	<link rel="stylesheet" href="css/responsive.css">
	<link rel="stylesheet" href="css/units.css">
	<!-- Storage helper with error handling -->
	<script src="js/storage.js"></script>
	<!-- Service Worker registration for caching -->
	<script>
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('service-worker.js')
				.then(reg => console.log('[SW] Registered:', reg))
				.catch(err => console.log('[SW] Registration failed:', err));
		}
	</script>
	
</head>
<body>
	<div class="app">
<aside class="sidebar">
	<div class="brand"><div class="logo">RG</div><h1>Riyadh Getaways</h1></div>
	<nav>
		<div class="nav-item active" data-link="dashboard.html"><i class="fa-solid fa-gauge"></i> <span data-i18n="dashboard">Dashboard</span></div>
		<div class="nav-item" data-link="calendar.html"><i class="fa-regular fa-calendar"></i> <span data-i18n="calendar">Calendar</span></div>
		<div class="nav-item" data-link="units.html"><i class="fa-solid fa-building"></i> <span data-i18n="units">Units</span></div>
		<div class="nav-item" data-link="website.html"><i class="fa-solid fa-globe"></i> <span data-i18n="website">Website Settings</span></div>
		<div class="nav-item" data-link="aiagent.html"><i class="fa-solid fa-robot"></i> <span data-i18n="aiagent">AI Agent</span></div>
		<div class="nav-item" data-link="contacts.html"><i class="fa-solid fa-address-book"></i> <span data-i18n="contacts">Contacts</span></div>
	</nav>
	<div class="sidebar-footer">© <strong>Riyadh Getaways</strong><br>Admin Dashboard</div>
</aside>

<main class="main">
	<header class="header">
		<div class="left">
			<button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle sidebar" style="display:none;background:none;border:none;cursor:pointer;font-size:20px;color:var(--sidebar);padding:8px;margin-right:8px"><i class="fa-solid fa-bars"></i></button>
			<h2 style="margin:0" id="headerTitle" data-i18n="dashboard">Dashboard</h2>
		</div>
		<div style="display:flex;align-items:center;gap:12px">
			<div class="search"><i class="fa-solid fa-magnifying-glass" style="color:var(--muted)"></i> <input placeholder="Search bookings, units, clients..." data-i18n-placeholder="searchPlaceholder" style="border:none;outline:none;margin-left:8px;font-size:14px;"></div>
			<div class="profile-container">
				<button class="profile-btn" id="profileBtn" aria-label="Profile menu">
					<div class="profile-avatar">RG</div>
					<i class="fa-solid fa-chevron-down" style="font-size:12px;color:var(--text-muted)"></i>
				</button>
				<div class="profile-dropdown" id="profileDropdown">
					<a href="#" class="dropdown-item" data-link="account-settings.html">
						<i class="fa-solid fa-user-gear"></i>
						<span data-i18n="accountSettings">Account Settings</span>
					</a>
					<div class="dropdown-divider"></div>
					<div class="dropdown-item language-switch">
						<i class="fa-solid fa-language"></i>
						<span data-i18n="language">Language</span>
						<div class="language-toggle">
							<button class="lang-btn" id="langEnBtn" onclick="setLanguage('en')">EN</button>
							<button class="lang-btn" id="langArBtn" onclick="setLanguage('ar')">عربي</button>
						</div>
					</div>
					<div class="dropdown-divider"></div>
					<a href="#" class="dropdown-item logout-item" onclick="handleLogout()">
						<i class="fa-solid fa-right-from-bracket"></i>
						<span data-i18n="logout">Logout</span>
					</a>
				</div>
			</div>
		</div>
	</header>

	<section class="content">
		
				<div>
					<!-- Units List Header -->
					<div style="display:flex;gap:8px;margin-bottom:20px;padding-bottom:8px;border-bottom:2px solid #e5e7eb;align-items:center;justify-content:flex-end">
						<button class="btn primary" onclick="openAddGroupModal()" style="flex-shrink:0"><i class="fa-solid fa-plus"></i> Add Group</button>
					</div>

					<div class="stat-cards">
						<div class="stat-card">
							<div class="stat-title">Total Units</div>
							<div class="stat-value" id="statTotal">0</div>
							<div class="stat-sub">All properties</div>
						</div>
						<div class="stat-card">
							<div class="stat-title">Active</div>
							<div class="stat-value" id="statActive">0</div>
							<div class="stat-sub">Bookable</div>
						</div>
						<div class="stat-card">
							<div class="stat-title">Maintenance</div>
							<div class="stat-value" id="statMaintenance">0</div>
							<div class="stat-sub">Unavailable</div>
						</div>
						<div class="stat-card">
							<div class="stat-title">Avg. Rate</div>
							<div class="stat-value" id="statADR">$0</div>
							<div class="stat-sub">Per night</div>
						</div>
					</div>

					<div class="toolbar">
						<div class="toolbar-left">
							<div class="filter"><i class="fa-solid fa-filter"></i><select id="statusFilter"><option value="all">All Statuses</option><option value="Active">Active</option><option value="Maintenance">Maintenance</option><option value="Disabled">Disabled</option></select></div>
						</div>
						<button class="btn primary" id="addUnitBtn"><i class="fa-solid fa-plus"></i> Add New Unit</button>
					</div>

					<div class="panel table-scroll-wrapper" style="overflow-x:auto">
						<table aria-label="Units list">
							<thead>
								<tr><th>Unit</th><th>Type</th><th>Max Guests</th><th>Nightly Rate</th><th>Status</th><th style="width:120px">Actions</th></tr>
							</thead>
							<tbody id="unitsTableBody"></tbody>
						</table>
					</div>
				</div>

				<aside class="side-panel">
					<div class="panel">
						<h3 style="margin-top:0">Amenities Overview</h3>
						<div class="tag-list" id="amenityTagList"></div>
					</div>
					<div class="panel">
						<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
							<h3 style="margin:0">Pricing Overrides</h3>
							<button class="btn ghost" onclick="openPricingOverrideModal()" style="padding:6px 12px;font-size:12px"><i class="fa-solid fa-plus"></i> Add</button>
						</div>
						<ul style="padding-left:0;color:var(--muted);margin:0;display:flex;flex-direction:column;gap:8px;list-style:none" id="pricingOverridesList"></ul>
					</div>
				</aside>
			
	</section>
</main>

<script src="js/utils.js"></script>

</div>

	<!-- Sheet -->
	<div class="sheet-backdrop" id="sheetBackdrop">
		<div class="sheet" role="dialog" aria-modal="true">
			<div class="sheet-header">
				<div>
					<h3 class="sheet-title" id="sheetTitle">Add Unit</h3>
					<div style="font-size:12px;color:var(--muted)" id="sheetSubtitle">Complete the form to create a new unit.</div>
				</div>
				<button class="close-btn" id="closeSheet" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
			</div>

			<div class="tabs">
				<button class="tab active" data-tab="basic">Basic Info</button>
				<button class="tab" data-tab="pricing">Pricing</button>
				<button class="tab" data-tab="amenities">Amenities & Features</button>
				<button class="tab" data-tab="media">Media</button>
				<button class="tab" data-tab="policy">Cancellation & Refund</button>
			</div>

			<div class="tab-panel active" id="tab-basic">
				<div class="field"><label for="unitName">Unit Name</label><input id="unitName" type="text" placeholder="e.g. Palm Oasis Chalet"></div>
				<div class="grid-2">
					<div class="field"><label for="unitType">Unit Type</label><select id="unitType" onchange="updatePropertyFields()"><option value="Chalet">Chalet</option><option value="Hotel Room">Hotel Room</option><option value="Hotel Apartment">Hotel Apartment</option></select></div>
					<div class="field"><label for="unitStatus">Status</label><select id="unitStatus"><option value="Active">Active</option><option value="Maintenance">Maintenance</option><option value="Disabled">Disabled</option></select></div>
				</div>

				<!-- Saudi Arabia Property-Specific Fields -->
				<!-- Chalet Fields -->
				<div id="chaletFields" style="display:none">
					<div class="grid-2">
						<div class="field">
							<div class="toggle-row"><input id="chaletPool" type="checkbox"><label for="chaletPool" style="margin:0">Has Pool</label></div>
							<input id="chaletPoolSpecs" type="text" placeholder="Pool specifications" disabled style="margin-top:6px">
						</div>
						<div class="field">
							<div class="toggle-row"><input id="chaletGarden" type="checkbox"><label for="chaletGarden" style="margin:0">Has Garden</label></div>
							<input id="chaletGardenSpecs" type="text" placeholder="Garden specifications" disabled style="margin-top:6px">
						</div>
					</div>
					<div class="field">
						<label for="chaletAreas">Entertainment Areas</label>
						<input id="chaletAreas" type="text" placeholder="e.g. BBQ area, lounge, game room">
					</div>
				</div>

				<!-- Hotel Fields -->
				<div id="hotelFields" style="display:none">
					<div class="grid-2">
						<div class="field"><label for="floorNumber">Floor Number</label><input id="floorNumber" type="number" min="1" placeholder="e.g. 5"></div>
						<div class="field"><label for="roomView">Room View</label><select id="roomView"><option value="">Select View Type</option><option value="City View">City View</option><option value="Garden View">Garden View</option><option value="Pool View">Pool View</option><option value="Partial View">Partial View</option></select></div>
					</div>
					<div class="grid-2">
						<div class="field"><label for="starRating">Star Rating</label><select id="starRating"><option value="">Select Rating</option><option value="3">3 Stars</option><option value="4">4 Stars</option><option value="5">5 Stars</option></select></div>
						<div class="field"><label for="amenitiesHotel">Key Amenities</label><input id="amenitiesHotel" type="text" placeholder="e.g. WiFi, AC, Mini Bar"></div>
					</div>
				</div>

				<!-- Apartment Fields -->
				<div id="apartmentFields" style="display:none">
					<div class="grid-2">
						<div class="field"><label for="apartmentFloor">Floor Number</label><input id="apartmentFloor" type="number" min="1" placeholder="e.g. 3"></div>
						<div class="field"><label for="apartmentView">View Type</label><select id="apartmentView"><option value="">Select View Type</option><option value="City View">City View</option><option value="Garden View">Garden View</option><option value="Courtyard View">Courtyard View</option></select></div>
					</div>
					<div class="field"><label for="roomSize">Room Size Category</label><select id="roomSize"><option value="">Select Size</option><option value="Studio">Studio</option><option value="1BR">1 Bedroom</option><option value="2BR">2 Bedrooms</option><option value="3BR">3 Bedrooms</option></select></div>
				</div>
				<div class="grid-2">
					<div class="field"><label for="unitArea">Unit Area (m²)</label><input id="unitArea" type="number" min="0" placeholder="e.g. 240"></div>
					<div class="field"><label for="maxGuests">Max Guests</label><input id="maxGuests" type="number" min="1" placeholder="e.g. 8"></div>
				</div>
				<div class="grid-2">
					<div class="field"><label for="nightlyRate">Nightly Rate (USD)</label><input id="nightlyRate" type="number" min="0" placeholder="e.g. 650"></div>
					<div class="field toggle-row" style="align-items:center"><input id="parkingToggle" type="checkbox"><label for="parkingToggle" style="margin:0">Parking available</label></div>
				</div>
				<div class="grid-2">
					<div class="field"><label for="checkInHour">Check-In Hour (24h)</label><input id="checkInHour" type="number" min="0" max="23" placeholder="e.g. 15"></div>
					<div class="field"><label for="checkOutHour">Check-Out Hour (24h)</label><input id="checkOutHour" type="number" min="0" max="23" placeholder="e.g. 11"></div>
				</div>
				<div class="field"><label for="shortDescription">Short Description</label><input id="shortDescription" type="text" placeholder="One-line summary"></div>
				<div class="field"><label for="longDescription">Long Description</label><textarea id="longDescription" placeholder="Describe the experience, layout, amenities..."></textarea></div>
			</div>

			<div class="tab-panel" id="tab-pricing">
				<div class="field">
					<label>Weekday Pricing (per night)</label>
					<div class="weekday-grid" id="weekdayPricingGrid"></div>
				</div>
				<div class="field">
					<div style="display:flex;justify-content:space-between;align-items:center">
						<label>Special Date Overrides</label>
						<button class="btn ghost" type="button" id="addOverrideBtn"><i class="fa-solid fa-plus"></i> Add Override</button>
					</div>
					<div class="override-list" id="overrideContainer"></div>
				</div>
			</div>

			<div class="tab-panel" id="tab-amenities">
				<div class="field"><label>Amenities</label>
					<div style="display:flex;flex-wrap:wrap;gap:10px" id="featureCheckboxes"></div>
				</div>
				<div class="grid-2">
					<div class="field">
						<div class="toggle-row"><input id="poolToggle" type="checkbox"><label for="poolToggle" style="margin:0">Has Pool</label></div>
						<input id="poolSpecs" type="text" placeholder="Pool specifications" disabled>
					</div>
					<div class="field">
						<div class="toggle-row"><input id="gardenToggle" type="checkbox"><label for="gardenToggle" style="margin:0">Has Garden</label></div>
						<input id="gardenSpecs" type="text" placeholder="Garden specifications" disabled>
					</div>
				</div>
				<div class="field">
					<div class="toggle-row"><input id="kitchenToggle" type="checkbox"><label for="kitchenToggle" style="margin:0">Has Kitchen</label></div>
					<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px" id="kitchenOptions"></div>
				</div>
				<div class="field">
					<div style="display:flex;justify-content:space-between;align-items:center"><label>Bedrooms</label><button class="btn ghost" type="button" id="addBedroomBtn"><i class="fa-solid fa-plus"></i> Add Bedroom</button></div>
					<div style="display:grid;gap:12px" id="bedroomsContainer"></div>
				</div>
				<div class="field">
					<div style="display:flex;justify-content:space-between;align-items:center"><label>Bathrooms</label><button class="btn ghost" type="button" id="addToiletBtn"><i class="fa-solid fa-plus"></i> Add Bathroom</button></div>
					<div style="display:grid;gap:12px" id="toiletsContainer"></div>
				</div>
			</div>

			<div class="tab-panel" id="tab-media">
				<div class="field">
					<label>Featured Image</label>
					<input id="featuredImageUpload" type="file" accept="image/*" style="padding:8px;border:2px dashed var(--accent);border-radius:8px">
					<div id="featuredImagePreview" style="margin-top:12px"></div>
				</div>

				<div class="field">
					<div style="display:flex;justify-content:space-between;align-items:center">
						<label>Gallery Images</label>
						<button class="btn ghost" type="button" id="addGalleryImageBtn" style="padding:6px 12px;font-size:12px"><i class="fa-solid fa-plus"></i> Add Image</button>
					</div>
					<div id="galleryImagesContainer" style="display:grid;gap:12px;margin-top:12px"></div>
				</div>

				<div class="field">
					<div style="display:flex;justify-content:space-between;align-items:center">
						<label>Unit Videos</label>
						<button class="btn ghost" type="button" id="addVideoBtn" style="padding:6px 12px;font-size:12px"><i class="fa-solid fa-plus"></i> Add Video</button>
					</div>
					<div id="videosContainer" style="display:grid;gap:12px;margin-top:12px"></div>
				</div>
			</div>

			<div class="tab-panel" id="tab-policy">
				<div class="field">
					<label>Cancellation & Refund Policy</label>
					<textarea id="policyText" placeholder="Enter your cancellation and refund policy here. Example: Free cancellation up to 7 days before check-in. After 7 days, full charge applies." style="min-height:250px"></textarea>
					<small style="color:var(--muted);margin-top:8px">Provide clear details about your cancellation terms, refund conditions, and any special policies.</small>
				</div>
			</div>

			<div class="sheet-actions">
				<button class="btn ghost" id="cancelSheet">Cancel</button>
				<button class="btn primary" id="saveUnitBtn">Save Unit</button>
			</div>
		</div>
	</div>
	
	<!-- Pricing Override Modal -->
	<div class="sheet-backdrop" id="pricingOverrideBackdrop">
		<div class="sheet" role="dialog" aria-modal="true" style="max-width:600px">
			<div class="sheet-header">
				<div>
					<h3 class="sheet-title" id="pricingOverrideTitle">Add Pricing Override</h3>
					<div style="font-size:12px;color:var(--muted)">Set special pricing for specific periods</div>
				</div>
				<button class="close-btn" id="closePricingOverride" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
			</div>
			
			<div style="padding:24px;display:flex;flex-direction:column;gap:16px;overflow-y:auto;max-height:calc(100vh - 200px)">
				<div class="field">
					<label for="overrideUnit">Unit</label>
					<select id="overrideUnit">
						<option value="">Select Unit</option>
						<!-- Options will be populated by JavaScript -->
					</select>
				</div>
				
				<div class="field">
					<label for="overrideGroup">Group</label>
					<select id="overrideGroup">
						<option value="">Select Group (Optional)</option>
						<!-- Options will be populated by JavaScript -->
					</select>
				</div>
				
				<div class="grid-2">
					<div class="field">
						<label for="overrideStartDate">Start Date</label>
						<input id="overrideStartDate" type="date" required>
					</div>
					<div class="field">
						<label for="overrideEndDate">End Date</label>
						<input id="overrideEndDate" type="date" required>
					</div>
				</div>
				
				<div class="field">
					<label for="overridePrice">Price (USD)</label>
					<input id="overridePrice" type="number" min="0" placeholder="e.g. 750" required>
				</div>
				
				<div class="field">
					<label for="overrideNotes">Notes</label>
					<textarea id="overrideNotes" placeholder="Optional notes about this override (e.g., Holiday pricing, Special event)" rows="3"></textarea>
				</div>
			</div>
			
			<div class="sheet-actions">
				<button class="btn ghost" id="cancelPricingOverride">Cancel</button>
				<button class="btn primary" id="savePricingOverride">Save Override</button>
			</div>
		</div>
	</div>
	
	<!-- Extracted JavaScript Files -->
	<script src="js/utils.js"></script>
	<script src="js/components.js"></script>
	
	<script>
		// Load saved theme color (safe with fallback)
		const savedColor = Storage.getString('websiteThemeColor', '');
		if(savedColor && /^#[0-9A-F]{6}$/i.test(savedColor)) {
			document.documentElement.style.setProperty('--accent', savedColor);
		}

		// Units data and groups management
		let unitsGroups = Storage.getJSON('unitsGroups', [
			{ id: 'group_1', name: 'Main Hotel', type: 'Hotel Room', license: 'TRN-2024-001' },
			{ id: 'group_2', name: 'Chalets Collection', type: 'Chalet', license: 'TRN-2024-002' }
		]);
		
		let units = Storage.getJSON('units', [
			{ id: 1, name: 'Luxury Ocean View Suite', type: 'Hotel Room', maxGuests: 4, nightlyRate: 1200, status: 'Active', groupId: 'group_1' },
			{ id: 2, name: 'Garden Villa with Private Pool', type: 'Chalet', maxGuests: 8, nightlyRate: 2500, status: 'Active', groupId: 'group_2' },
			{ id: 3, name: 'Downtown Executive Apartment', type: 'Hotel Apartment', maxGuests: 6, nightlyRate: 950, status: 'Maintenance', groupId: 'group_1' }
		]);
		
		let currentGroupId = Storage.getString('currentGroupId', 'all');
		
		// Update property-specific fields based on unit type selection
		function updatePropertyFields() {
			const unitType = document.getElementById('unitType')?.value;
			const chaletFields = document.getElementById('chaletFields');
			const hotelFields = document.getElementById('hotelFields');
			const apartmentFields = document.getElementById('apartmentFields');
			
			// Hide all property-specific fields
			if (chaletFields) chaletFields.style.display = 'none';
			if (hotelFields) hotelFields.style.display = 'none';
			if (apartmentFields) apartmentFields.style.display = 'none';
			
			// Show relevant fields based on type
			if (unitType === 'Chalet') {
				if (chaletFields) chaletFields.style.display = 'block';
			} else if (unitType === 'Hotel Room') {
				if (hotelFields) hotelFields.style.display = 'block';
			} else if (unitType === 'Hotel Apartment') {
				if (apartmentFields) apartmentFields.style.display = 'block';
			}
			
			// Handle pool/garden toggles for chalets
			const chaletPool = document.getElementById('chaletPool');
			const chaletPoolSpecs = document.getElementById('chaletPoolSpecs');
			const chaletGarden = document.getElementById('chaletGarden');
			const chaletGardenSpecs = document.getElementById('chaletGardenSpecs');
			
			if (chaletPool) {
				chaletPool.addEventListener('change', function() {
					if (chaletPoolSpecs) chaletPoolSpecs.disabled = !this.checked;
				});
			}
			
			if (chaletGarden) {
				chaletGarden.addEventListener('change', function() {
					if (chaletGardenSpecs) chaletGardenSpecs.disabled = !this.checked;
				});
			}
		}
		
		// Populate group tabs
		function populateGroupTabs() {
			const groupsTabs = document.getElementById('groupsTabs');
			if (!groupsTabs) return;
			
			groupsTabs.innerHTML = '';
			
			// Add "All Groups" tab
			const allTab = document.createElement('div');
			allTab.className = 'group-tab' + (currentGroupId === 'all' ? ' active' : '');
			allTab.textContent = 'All Groups';
			allTab.style.cssText = 'padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s';
			allTab.style.background = currentGroupId === 'all' ? 'var(--accent)' : '#f3f4f6';
			allTab.style.color = currentGroupId === 'all' ? '#fff' : '#64748b';
			allTab.addEventListener('click', () => switchGroup('all'));
			groupsTabs.appendChild(allTab);
			
			// Add group tabs
			unitsGroups.forEach(group => {
				const tab = document.createElement('div');
				tab.className = 'group-tab' + (currentGroupId === group.id ? ' active' : '');
				tab.textContent = `${group.name} (${group.type})`;
				tab.style.cssText = 'padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s;white-space:nowrap';
				tab.style.background = currentGroupId === group.id ? 'var(--accent)' : '#f3f4f6';
				tab.style.color = currentGroupId === group.id ? '#fff' : '#64748b';
				tab.addEventListener('click', () => switchGroup(group.id));
				groupsTabs.appendChild(tab);
			});
		}
		
		// Switch active group
		function switchGroup(groupId) {
			currentGroupId = groupId;
			Storage.setString('currentGroupId', groupId);
			populateGroupTabs();
			renderUnitsTable();
			updateStats();
		}
		
		// Render units table
		function renderUnitsTable() {
			const tbody = document.getElementById('unitsTableBody');
			if (!tbody) return;
			
			const filteredUnits = currentGroupId === 'all' 
				? units 
				: units.filter(u => u.groupId === currentGroupId);
			
			tbody.innerHTML = '';
			
			if (filteredUnits.length === 0) {
				tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#64748b">No units found. Click "Add New Unit" to get started.</td></tr>';
				return;
			}
			
			filteredUnits.forEach(unit => {
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td><strong>${unit.name}</strong></td>
					<td>${unit.type}</td>
					<td>${unit.maxGuests}</td>
					<td>$${unit.nightlyRate}</td>
					<td><span class="status ${unit.status.toLowerCase()}">${unit.status}</span></td>
					<td style="text-align:center">
						<button class="btn ghost" style="padding:4px 8px;font-size:12px" onclick="editUnit(${unit.id})">
							<i class="fa-solid fa-pen"></i> Edit
						</button>
						<button class="btn ghost" style="padding:4px 8px;font-size:12px;color:#ef4444" onclick="deleteUnit(${unit.id})">
							<i class="fa-solid fa-trash"></i>
						</button>
					</td>
				`;
				tbody.appendChild(tr);
			});
		}
		
		// Update statistics
		function updateStats() {
			const filteredUnits = currentGroupId === 'all' 
				? units 
				: units.filter(u => u.groupId === currentGroupId);
			
			document.getElementById('statTotal').textContent = filteredUnits.length;
			document.getElementById('statActive').textContent = filteredUnits.filter(u => u.status === 'Active').length;
			document.getElementById('statMaintenance').textContent = filteredUnits.filter(u => u.status === 'Maintenance').length;
			
			const avgRate = filteredUnits.length > 0 
				? Math.round(filteredUnits.reduce((sum, u) => sum + u.nightlyRate, 0) / filteredUnits.length)
				: 0;
			document.getElementById('statADR').textContent = '$' + avgRate;
		}
		
		// Open add group modal
		function openAddGroupModal() {
			const name = prompt('Group Name:');
			if (!name) return;
			
			const type = prompt('Group Type (e.g., Hotel, Chalet, Apartment):');
			if (!type) return;
			
			const license = prompt('License Number (optional):') || '';
			
			const newGroup = {
				id: 'group_' + Date.now(),
				name: name,
				type: type,
				license: license
			};
			
			unitsGroups.push(newGroup);
			Storage.setJSON('unitsGroups', unitsGroups);
			
			populateGroupTabs();
			showConfirmation('Group added successfully!');
		}
		
		// Open/Close sheet modal functions
		function openAddUnitSheet() {
			const backdrop = document.getElementById('sheetBackdrop');
			const title = document.getElementById('sheetTitle');
			const subtitle = document.getElementById('sheetSubtitle');
			
			if (backdrop) {
				title.textContent = 'Add Unit';
				subtitle.textContent = 'Complete the form to create a new unit.';
				
				// Reset form
				document.getElementById('unitName').value = '';
				document.getElementById('unitType').value = 'Chalet';
				document.getElementById('unitStatus').value = 'Active';
				document.getElementById('unitArea').value = '';
				document.getElementById('maxGuests').value = '';
				document.getElementById('nightlyRate').value = '';
				document.getElementById('parkingToggle').checked = false;
				document.getElementById('checkInHour').value = '15';
				document.getElementById('checkOutHour').value = '11';
				document.getElementById('shortDescription').value = '';
				document.getElementById('longDescription').value = '';
				
				// Populate weekday pricing grid
				populateWeekdayPricing();
				
				// Switch to first tab
				document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
				document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
				document.querySelector('.tab[data-tab="basic"]')?.classList.add('active');
				document.getElementById('tab-basic')?.classList.add('active');
				
				// Update property fields based on default type
				updatePropertyFields();
				
				backdrop.classList.add('show');
			}
		}
		
		// Populate weekday pricing inputs
		function populateWeekdayPricing(prices = {}) {
			const grid = document.getElementById('weekdayPricingGrid');
			if (!grid) return;
			
			const weekdays = [
				{ key: 'sunday', label: 'Sunday' },
				{ key: 'monday', label: 'Monday' },
				{ key: 'tuesday', label: 'Tuesday' },
				{ key: 'wednesday', label: 'Wednesday' },
				{ key: 'thursday', label: 'Thursday' },
				{ key: 'friday', label: 'Friday' },
				{ key: 'saturday', label: 'Saturday' }
			];
			
			grid.innerHTML = '';
			
			weekdays.forEach(day => {
				const card = document.createElement('div');
				card.className = 'weekday-card';
				card.innerHTML = `
					<label style="font-weight:600;font-size:12px;color:#64748b;text-transform:uppercase">${day.label}</label>
					<input type="number" id="price_${day.key}" min="0" placeholder="Price (USD)" value="${prices[day.key] || ''}" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px">
				`;
				grid.appendChild(card);
			});
		}
		
		function closeUnitSheet() {
			const backdrop = document.getElementById('sheetBackdrop');
			if (backdrop) backdrop.classList.remove('show');
		}
		
		// Add unit button handler
		document.getElementById('addUnitBtn')?.addEventListener('click', openAddUnitSheet);
		
		// Close sheet handlers
		document.getElementById('closeSheet')?.addEventListener('click', closeUnitSheet);
		document.getElementById('cancelSheet')?.addEventListener('click', closeUnitSheet);
		
		// Tab switching
		document.querySelectorAll('.tab').forEach(tab => {
			tab.addEventListener('click', () => {
				const targetTab = tab.getAttribute('data-tab');
				
				// Remove active class from all tabs and panels
				document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
				document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
				
				// Add active class to clicked tab and corresponding panel
				tab.classList.add('active');
				document.getElementById(`tab-${targetTab}`)?.classList.add('active');
			});
		});
		
		// Save unit handler
		document.getElementById('saveUnitBtn')?.addEventListener('click', () => {
			const name = document.getElementById('unitName').value;
			const type = document.getElementById('unitType').value;
			const status = document.getElementById('unitStatus').value;
			const maxGuests = parseInt(document.getElementById('maxGuests').value) || 0;
			const nightlyRate = parseFloat(document.getElementById('nightlyRate').value) || 0;
			
			if (!name || !type || !maxGuests || !nightlyRate) {
				alert('Please fill in all required fields (Name, Type, Max Guests, Nightly Rate)');
				return;
			}
			
			let groupId = currentGroupId;
			if (currentGroupId === 'all' && unitsGroups.length > 0) {
				groupId = unitsGroups[0].id;
			}
			
			// Collect weekday prices
			const weekdayPrices = {
				sunday: parseFloat(document.getElementById('price_sunday')?.value) || null,
				monday: parseFloat(document.getElementById('price_monday')?.value) || null,
				tuesday: parseFloat(document.getElementById('price_tuesday')?.value) || null,
				wednesday: parseFloat(document.getElementById('price_wednesday')?.value) || null,
				thursday: parseFloat(document.getElementById('price_thursday')?.value) || null,
				friday: parseFloat(document.getElementById('price_friday')?.value) || null,
				saturday: parseFloat(document.getElementById('price_saturday')?.value) || null
			};
			
			if (currentEditUnitId) {
				// Edit existing unit
				const unit = units.find(u => u.id === currentEditUnitId);
				if (unit) {
					unit.name = name;
					unit.type = type;
					unit.status = status;
					unit.maxGuests = maxGuests;
					unit.nightlyRate = nightlyRate;
					unit.area = parseFloat(document.getElementById('unitArea').value) || 0;
					unit.parking = document.getElementById('parkingToggle').checked;
					unit.checkInHour = parseInt(document.getElementById('checkInHour').value) || 15;
					unit.checkOutHour = parseInt(document.getElementById('checkOutHour').value) || 11;
					unit.shortDescription = document.getElementById('shortDescription').value;
					unit.longDescription = document.getElementById('longDescription').value;
					unit.weekdayPrices = weekdayPrices;
				}
				currentEditUnitId = null;
				showConfirmation('Unit updated successfully!');
			} else {
				// Add new unit
				const newUnit = {
					id: Date.now(),
					name: name,
					type: type,
					status: status,
					maxGuests: maxGuests,
					nightlyRate: nightlyRate,
					groupId: groupId,
					weekdayPrices: weekdayPrices
				};
				
				units.push(newUnit);
				showConfirmation('Unit added successfully!');
			}
			
			Storage.setJSON('units', units);
			
			closeUnitSheet();
			renderUnitsTable();
			updateStats();
		});
		
		// Edit unit
		let currentEditUnitId = null;
		
		function editUnit(id) {
			const unit = units.find(u => u.id === id);
			if (!unit) return;
			
			currentEditUnitId = id;
			const backdrop = document.getElementById('sheetBackdrop');
			const title = document.getElementById('sheetTitle');
			const subtitle = document.getElementById('sheetSubtitle');
			
			if (backdrop) {
				title.textContent = 'Edit Unit';
				subtitle.textContent = 'Update the unit information.';
				
				// Populate form with unit data
				document.getElementById('unitName').value = unit.name || '';
				document.getElementById('unitType').value = unit.type || 'Chalet';
				document.getElementById('unitStatus').value = unit.status || 'Active';
				document.getElementById('unitArea').value = unit.area || '';
				document.getElementById('maxGuests').value = unit.maxGuests || '';
				document.getElementById('nightlyRate').value = unit.nightlyRate || '';
				document.getElementById('parkingToggle').checked = unit.parking || false;
				document.getElementById('checkInHour').value = unit.checkInHour || '15';
				document.getElementById('checkOutHour').value = unit.checkOutHour || '11';
				document.getElementById('shortDescription').value = unit.shortDescription || '';
				document.getElementById('longDescription').value = unit.longDescription || '';
				
				// Populate weekday pricing grid with unit data
				populateWeekdayPricing(unit.weekdayPrices || {});
				
				// Switch to first tab
				document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
				document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
				document.querySelector('.tab[data-tab="basic"]')?.classList.add('active');
				document.getElementById('tab-basic')?.classList.add('active');
				
				// Update property fields based on type
				updatePropertyFields();
				
				backdrop.classList.add('show');
			}
		}
		
		// Delete unit
		function deleteUnit(id) {
			if (!confirm('Are you sure you want to delete this unit?')) return;
			
			units = units.filter(u => u.id !== id);
			Storage.setJSON('units', units);
			
			renderUnitsTable();
			updateStats();
			showConfirmation('Unit deleted successfully!');
		}
		
		// Pricing Overrides Management
		let pricingOverrides = Storage.getJSON('pricingOverrides', []);
		let currentOverrideId = null;
		
		function openPricingOverrideModal(overrideId = null) {
			const backdrop = document.getElementById('pricingOverrideBackdrop');
			const title = document.getElementById('pricingOverrideTitle');
			const unitSelect = document.getElementById('overrideUnit');
			const groupSelect = document.getElementById('overrideGroup');
			
			if (!backdrop) return;
			
			// Populate units dropdown
			unitSelect.innerHTML = '<option value="">Select Unit</option>';
			units.forEach(unit => {
				const option = document.createElement('option');
				option.value = unit.id;
				option.textContent = unit.name;
				unitSelect.appendChild(option);
			});
			
			// Populate groups dropdown
			groupSelect.innerHTML = '<option value="">Select Group (Optional)</option>';
			unitsGroups.forEach(group => {
				const option = document.createElement('option');
				option.value = group.id;
				option.textContent = group.name;
				groupSelect.appendChild(option);
			});
			
			if (overrideId) {
				// Edit mode
				const override = pricingOverrides.find(o => o.id === overrideId);
				if (override) {
					currentOverrideId = overrideId;
					title.textContent = 'Edit Pricing Override';
					document.getElementById('overrideUnit').value = override.unitId || '';
					document.getElementById('overrideGroup').value = override.groupId || '';
					document.getElementById('overrideStartDate').value = override.startDate;
					document.getElementById('overrideEndDate').value = override.endDate;
					document.getElementById('overridePrice').value = override.price;
					document.getElementById('overrideNotes').value = override.notes || '';
				}
			} else {
				// Add mode
				currentOverrideId = null;
				title.textContent = 'Add Pricing Override';
				document.getElementById('overrideUnit').value = '';
				document.getElementById('overrideGroup').value = '';
				document.getElementById('overrideStartDate').value = '';
				document.getElementById('overrideEndDate').value = '';
				document.getElementById('overridePrice').value = '';
				document.getElementById('overrideNotes').value = '';
			}
			
			backdrop.classList.add('show');
		}
		
		function closePricingOverrideModal() {
			const backdrop = document.getElementById('pricingOverrideBackdrop');
			if (backdrop) backdrop.classList.remove('show');
			currentOverrideId = null;
		}
		
		function savePricingOverride() {
			const unitId = document.getElementById('overrideUnit').value;
			const groupId = document.getElementById('overrideGroup').value;
			const startDate = document.getElementById('overrideStartDate').value;
			const endDate = document.getElementById('overrideEndDate').value;
			const price = parseFloat(document.getElementById('overridePrice').value);
			const notes = document.getElementById('overrideNotes').value;
			
			if (!startDate || !endDate || !price) {
				alert('Please fill in all required fields');
				return;
			}
			
			if (!unitId && !groupId) {
				alert('Please select either a unit or a group');
				return;
			}
			
			const overrideData = {
				id: currentOverrideId || Date.now(),
				unitId,
				groupId,
				startDate,
				endDate,
				price,
				notes,
				createdAt: new Date().toISOString()
			};
			
			if (currentOverrideId) {
				// Update existing
				const index = pricingOverrides.findIndex(o => o.id === currentOverrideId);
				if (index !== -1) pricingOverrides[index] = overrideData;
			} else {
				// Add new
				pricingOverrides.push(overrideData);
			}
			
			Storage.setJSON('pricingOverrides', pricingOverrides);
			closePricingOverrideModal();
			renderPricingOverrides();
			showConfirmation('Pricing override saved successfully!');
		}
		
		function deletePricingOverride(id) {
			if (!confirm('Are you sure you want to delete this pricing override?')) return;
			
			pricingOverrides = pricingOverrides.filter(o => o.id !== id);
			Storage.setJSON('pricingOverrides', pricingOverrides);
			renderPricingOverrides();
			showConfirmation('Pricing override deleted successfully!');
		}
		
		function renderPricingOverrides() {
			const list = document.getElementById('pricingOverridesList');
			if (!list) return;
			
			if (pricingOverrides.length === 0) {
				list.innerHTML = '<li style="color:var(--muted);font-size:13px">No pricing overrides set</li>';
				return;
			}
			
			list.innerHTML = '';
			pricingOverrides.forEach(override => {
				const li = document.createElement('li');
				li.style.cssText = 'background:#f8fafc;padding:12px;border-radius:8px;border:1px solid #e5e7eb';
				
				let targetText = '';
				if (override.unitId) {
					const unit = units.find(u => u.id == override.unitId);
					targetText = unit ? unit.name : 'Unknown Unit';
				} else if (override.groupId) {
					const group = unitsGroups.find(g => g.id === override.groupId);
					targetText = group ? `${group.name} (Group)` : 'Unknown Group';
				}
				
				li.innerHTML = `
					<div style="display:flex;justify-content:space-between;align-items:start;gap:8px">
						<div style="flex:1;min-width:0">
							<div style="font-weight:600;color:#111;font-size:13px;margin-bottom:4px">${targetText}</div>
							<div style="font-size:12px;color:var(--muted);margin-bottom:2px">${override.startDate} to ${override.endDate}</div>
							<div style="font-size:13px;color:var(--accent);font-weight:600">$${override.price}/night</div>
							${override.notes ? `<div style="font-size:11px;color:var(--muted);margin-top:4px;font-style:italic">${override.notes}</div>` : ''}
						</div>
						<div style="display:flex;gap:6px;flex-shrink:0">
							<button class="icon-btn" onclick="openPricingOverrideModal(${override.id})" title="Edit" style="width:28px;height:28px;font-size:11px">
								<i class="fa-solid fa-pen"></i>
							</button>
							<button class="icon-btn danger" onclick="deletePricingOverride(${override.id})" title="Delete" style="width:28px;height:28px;font-size:11px">
								<i class="fa-solid fa-trash"></i>
							</button>
						</div>
					</div>
				`;
				
				list.appendChild(li);
			});
		}
		
		// Setup pricing override modal handlers
		document.getElementById('closePricingOverride')?.addEventListener('click', closePricingOverrideModal);
		document.getElementById('cancelPricingOverride')?.addEventListener('click', closePricingOverrideModal);
		document.getElementById('savePricingOverride')?.addEventListener('click', savePricingOverride);
		
		// Close modal on backdrop click
		document.getElementById('pricingOverrideBackdrop')?.addEventListener('click', (e) => {
			if (e.target.id === 'pricingOverrideBackdrop') closePricingOverrideModal();
		});
		
		// Initialize on load
		populateGroupTabs();
		renderUnitsTable();
		updateStats();
		renderPricingOverrides();

		// Mobile sidebar toggle functionality
		const sidebarToggle = document.getElementById('sidebarToggle');
		const sidebar = document.querySelector('.sidebar');
		
		if(sidebarToggle && sidebar) {
			sidebarToggle.addEventListener('click', (e) => {
				e.stopPropagation();
				sidebar.classList.toggle('active');
			});
			
			// Close sidebar when clicking on nav items
			document.querySelectorAll('.nav-item').forEach(item => {
				item.addEventListener('click', () => {
					sidebar.classList.remove('active');
				});
			});
			
			// Close sidebar when clicking outside
			document.addEventListener('click', (e) => {
				if(!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
					sidebar.classList.remove('active');
			}
		});
	}
</script>
	</div>
</body>
</html>